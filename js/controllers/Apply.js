"use strict";WeChat.controller("ApplyRepairCtrl",["$scope","$http","$cookies","$timeout","$mdSidenav","$mdUtil","$cacheFactory","$modal","$mdDialog","i18n",function(c,d,u,t,a,e,i,r,s,n){c.RepairParameters={},c.AppId=window.localStorage.getItem("b2c_appId"),c.Maintenance=0,c.InspectionStyle=1,c.StoreList=[],c.CauseList=[],c.EquipmentName="",c.AreaStr="",c.itemsAreaStr=[],c.itemsCauseStr=[],c.PriorityId="",c.Unit=u.Unit,c.CauseSelect=[],c.Record={},c.isStore=!1,c.isStart=!1,c.isplayVoice=!1,c.isSubmit=!1,c.isShowSetting=!1,c.isWPStoreUser=!1,c.isShowArea=!0,c.CompanyId=u.CompanyId,c.StoreUser=u.StoreUser,c.StoreSearch="",c.imagesList={WholeIds:[],localIds:[],allIds:[],serverIds:[]},c.Record={localId:"",serverId:""},c.SettingInfo=[{nCount:null,nHeight:null,nWidth:null,nLong:null}],c.RepairParameters={StageId:0,Source:4,UserId:u.UserId,UserName:u.UserName,UnitId:u.UnitId,Unit:u.Unit,IPositionIds:[],ICauseIds:[],CauseId:"",Causes:"",Description:"",ImageMediaIds:[],VoiceMediaId:"",CompanyId:u.CompanyId},c.MediasParamenter={Key:"",FileSoure:40,Medias:{image:[],voice:[]}},c.equipment={UnitId:u.UnitId,Unit:u.Unit,EquipmentTypeClass:0,EquipmentTypeId:"",EquipmentTypeName:"",EquipmentName:"",EquipmentCode:"",IPositionIds:[]},c.EquipmentList=[{EquipmentTypeClass:0,ClassName:"设备",children:[]},{EquipmentTypeClass:1,ClassName:"设施",children:[]},{EquipmentTypeClass:2,ClassName:"资讯",children:[]},{EquipmentTypeClass:99,ClassName:"其它",children:[]}],c.Equipmentpos=[],c.TypeList=[],c.StoreUser=u.StoreUser,c.IsShowToScanQRCode=!1,c.IsShowAddCause=!1,c.IsWPStylePriorityList=!1,c.IsAutoSetPosition=!1;var o=["f96f98e2-38f9-456a-9813-82d899536a82","eb296708-6fc6-43f0-b506-0ca0fa91e1cd","6c690014-2571-48db-ac5a-c6ba2572a3bb","c1a24352-46a1-4301-9b96-a67c92691336","C4B0E179-8121-487E-AA63-59635ACF2447"];-1<o.indexOf(u.CompanyId)&&(c.IsShowToScanQRCode=!0,c.IsShowAddCause=!0,c.IsWPStylePriorityList=!0,"f96f98e2-38f9-456a-9813-82d899536a82"!==u.CompanyId&&"c1a24352-46a1-4301-9b96-a67c92691336"!==u.CompanyId&&(c.isWPStoreUser=!0)),-1<o.indexOf(u.CompanyId)&&(c.IsAutoSetPosition=!0),c.Load_WX=function(){wx.config({debug:!1,appId:c.AppId,timestamp:1437377735,nonceStr:"n580440",signature:window.localStorage.getItem(c.AppId+"_signature"),jsApiList:["checkJsApi","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","translateVoice","startRecord","stopRecord","onRecordEnd","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard"]}),wx.error(function(e){d({url:ApiMapper.wxApi+"/wx/r/ticket/"+c.AppId,method:"GET",cache:!1,contentType:"application/json"}).success(function(e){var t=e;window.localStorage.setItem(c.AppId+"_ticket",t);var a="jsapi_ticket="+t+"&noncestr=n580440&timestamp=1437377735&url="+window.location.href;window.localStorage.setItem(c.AppId+"_signature",hex_sha1(a)),c.Load_WX()})})},c.Load_WX(),c.exists=function(e,t){return-1<t.indexOf(e)},c.GetStore=function(){d({url:ApiMapper.sApi+"/s/unit/maps",method:"GET",cache:!0,contentType:"application/json",headers:{Passport:u.Passport}}).success(function(i){console.log(n.t("1001")),c.Unitdata=i,_.forEach(i[1],function(a){c.UnitLeve4data=[],a.isSelected=!1,_.forEach(i[3],function(e){if(c.UnitLeve4data.push(e),e.Level2==a.UnitId&&(e.Level2Name=a.Unit,e.isSelected=!1),e.UnitId==u.UnitId&&(c.isStore=!0,c.Unit=e.Unit,c.RepairParameters.UnitId=e.UnitId,c.RepairParameters.Unit=e.Unit),!c.isStore){var t=i[0];c.Unit=t[0].Unit}}),c.StoreList.push(a)}),c.GetEquipment(u.UnitId)}).error(function(e){alert("获取部门信息错误！")})},c.GetStore(),c.AreaIds=[],c.ProvinceIds=[],c.isSelectLeve2=function(t){_.forEach(c.Unitdata[1],function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&(c.AreaIds=[t.UnitId],c.ProvinceIds=[]),c.UnitLeve3data=_.filter(c.Unitdata[2],function(e){return e.Level2==t.UnitId})},c.isSelectLeve3=function(t){_.forEach(c.Unitdata[2],function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&(c.ProvinceIds=[t.UnitId])},c.reLoadLeve4=function(){c.UnitLeve4data=_.filter(c.Unitdata[3],function(e){return 0<c.ProvinceIds.length?e.Level3==c.ProvinceIds[0]:e.Level2==c.AreaIds[0]})},c.isSelectLeve4=function(t){_.forEach(c.UnitLeve4data,function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&(c.Unit=t.Unit,c.RepairParameters.Unit=t.Unit,c.RepairParameters.UnitId=t.UnitId,c.RepairParameters.EquipmentCode="",c.EquipmentName="",c.RepairParameters.ICauseIds=[],c.CauseList=[],c.itemsCauseStr=[],c.ICauses="",c.setSelect4Cause(),c.GetEquipment(c.RepairParameters.UnitId))},c.SetEstDate=function(){c.RepairParameters.EstArrivalTime=GetNow(),c.EstArrivalTime=FormatDate(GetNow()),$('input[name="EstArrivalDate"]').val(c.EstArrivalTime)},$('input[name="EstArrivalDate"]').daterangepicker({singleDatePicker:!0,showDropdowns:!1,format:"YYYY/MM/DD",minDate:GetNow()}),c.setInspection=function(e){c.Maintenance=e,c.IsInspection=0!=e,c.SetEstDate(),null!=c.RepairParameters.UnitId&&""!=c.RepairParameters.UnitId&&(c.reloadParameters(),c.GetEquipment())},c.reloadParameters=function(){c.AreaStr="",c.ICauses="",c.EquipmentName="",c.RepairParameters.EquipmentCode="",c.RepairParameters.EquipmentName="",c.AreasList=[],c.CauseList=[],c.PriorityList=[],c.EquipmentList=[{EquipmentTypeClass:0,ClassName:"设备",children:[]},{EquipmentTypeClass:1,ClassName:"设施",children:[]},{EquipmentTypeClass:2,ClassName:"资讯",children:[]},{EquipmentTypeClass:99,ClassName:"其它",children:[]}]},c.ToscanQRCode=function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){c.QRCodeStr=e.resultStr,d({url:ApiMapper.sApi+"/s/equipment/code/"+encodeURIComponent(c.QRCodeStr),contentType:"application/json",headers:{Passport:u.Passport},method:"GET"}).success(function(e){c.RepairParameters.EquipmentCode=e.EquipmentCode,c.RepairParameters.EquipmentTypeId=e.EquipmentTypeId,c.RepairParameters.EquipmentTypeClass=e.EquipmentTypeClass,c.RepairParameters.EquipmentId=e.EquipmentId,c.RepairParameters.EquipmentName=e.EquipmentName,c.EquipmentName="["+e.EquipmentCode+"]  "+e.EquipmentName,c.RepairParameters.IPositionIds=[],c.RepairParameters.IPositionIds=e.IPositionIds,c.GetPriority(),c.GetCause(),c.GetMaintainer()}).error(function(e){alert(e.Messages)})}})},c.GetMaintainer=function(){d({url:ApiMapper.sApi+"/s/punit/allocated/"+c.RepairParameters.EquipmentTypeClass+"/"+c.RepairParameters.EquipmentId,contentType:"application/json",headers:{Passport:u.Passport},method:"GET"}).success(function(e){c.RepairParameters.MaintainerId=e.MaintainerId,c.RepairParameters.MaintainerName=e.MaintainerName,c.RepairParameters.StrongholdId=e.StrongholdId,c.RepairParameters.StrongholdName=e.StrongholdName,c.GetMaintainerInfo()}).error(function(e){alert(e.Messages)})},c.GetMaintainerInfo=function(){d({url:ApiMapper.ccApi+"/g/punit/"+c.RepairParameters.MaintainerId+"/"+c.RepairParameters.StrongholdId,method:"GET",contentType:"application/json",headers:{Passport:u.Passport},cache:!1}).success(function(e){var t=c.RepairParameters.MaintainerName+"-"+c.RepairParameters.StrongholdName+"\n 联系人：";0<e.Liaison.length&&_.forEach(e.Liaison,function(e){null!=e.Name&&""!=e.Name&&(t+=e.Name.toString()),null!=e.PhoneNo&&""!=e.PhoneNo&&(t+="  联系电话："+e.PhoneNo.toString()+"\n")}),c.RepairParameters.StrongholdInfo=t})},c.GetEquipment=function(e){c.reloadParameters();var t={UnitId:c.RepairParameters.UnitId,TopicType:1,Maintenance:c.Maintenance};"eb296708-6fc6-43f0-b506-0ca0fa91e1cd"!=c.CompanyId&&"6c690014-2571-48db-ac5a-c6ba2572a3bb"!=c.CompanyId&&"C4B0E179-8121-487E-AA63-59635ACF2447"!=c.CompanyId||(t.TopicType=3,c.EquipmentList[0]={EquipmentTypeClass:0,ClassName:"设备",children:[]},c.EquipmentList[1]={EquipmentTypeClass:1,ClassName:"设施",children:[]},c.GetFacilities()),d({url:ApiMapper.sApi+"/s/equipment/classification",method:"POST",contentType:"application/json",headers:{Passport:u.Passport},data:JSON.stringify(t)}).success(function(e){"eb296708-6fc6-43f0-b506-0ca0fa91e1cd"==c.CompanyId||"6c690014-2571-48db-ac5a-c6ba2572a3bb"==c.CompanyId||"C4B0E179-8121-487E-AA63-59635ACF2447"==c.CompanyId?c.EquipmentList[0].children=e:(c.EquipmentList=[{EquipmentTypeClass:0,ClassName:"设备",children:[]},{EquipmentTypeClass:1,ClassName:"设施",children:[]},{EquipmentTypeClass:2,ClassName:"资讯",children:[]},{EquipmentTypeClass:99,ClassName:"其它",children:[]}],_(e).each(function(t){var e=t.children;_(e).each(function(a){a.EquipmentTypeName=t.EquipmentTypeName;var e=a.EquipmentCode.split("-");a.SortNo=parseInt(e[1]),c.EquipmentList.forEach(function(e,t){e.EquipmentTypeClass==a.EquipmentTypeClass&&c.EquipmentList[t].children.push(a)})})}),_(c.EquipmentList).each(function(e){e.children=_.sortBy(e.children,"SortNo")}))})},c.GetFacilities=function(){var e={UnitId:c.RepairParameters.UnitId,TopicType:4,Maintenance:c.Maintenance};d({url:ApiMapper.sApi+"/s/equipment/classification",method:"POST",contentType:"application/json",headers:{Passport:u.Passport},data:JSON.stringify(e)}).success(function(e){_(e).each(function(a){var e=a.children;_(e).each(function(e){e.EquipmentTypeName=a.EquipmentTypeName;var t=e.EquipmentCode.split("-");e.SortNo=parseInt(t[1]),c.EquipmentList[1].children.push(e)})})})},c.reloadCause=function(){c.CauseList=[],c._CauseList=[],c.PriorityList=[],c.RepairParameters.Priority="",c.RepairParameters.Emergency=0,c.RepairParameters.Limitation=0},c.ShowArea=function(e,a){"设施"===a&&c.isWPStoreUser?c.isShowArea=!1:c.isShowArea=!0,""==c.RepairParameters.EquipmentCode&&(c.AreasList=[],c.CauseList=[],c.PriorityList=[],c.ICauses="",c.RepairParameters.EquipmentTypeId="",c.RepairParameters.EquipmentTypeClass="",c.RepairParameters.EquipmentId="",c.RepairParameters.EquipmentName="",c.RepairParameters.IsRezPhotos=0,c.RepairParameters.IPositionIds=[],c.RepairParameters.MaintainerId="",c.RepairParameters.StrongholdId="",c.RepairParameters.IsSupportArea=0,c.reloadCause()),c.RepairParameters.EquipmentCode=e.EquipmentCode,c.RepairParameters.EquipmentTypeId=e.EquipmentTypeId,c.RepairParameters.EquipmentTypeClass=e.EquipmentTypeClass,c.RepairParameters.EquipmentId=e.EquipmentId,c.RepairParameters.EquipmentName=e.EquipmentName,c.RepairParameters.IsRezPhotos=e.IsRezPhotos,c.RepairParameters.IPositionIds=e.PositionIds.split(),c.RepairParameters.MaintainerId=e.MaintainerId,c.RepairParameters.StrongholdId=e.StrongholdId,c.RepairParameters.IsSupportArea=e.IsSupportArea,c.EquipmentName="["+c.RepairParameters.EquipmentCode+"]  "+c.RepairParameters.EquipmentName,c.reloadCause(),c.IsInspection?c.getCause4Inspection():c.GetCause(),d({url:ApiMapper.sApi+"/s/equipmentpos/"+e.EquipmentId,method:"GET",contentType:"application/json",headers:{Passport:u.Passport}}).success(function(e,t){c.RepairParameters.IPositionIds=[],c.itemsAreaStr=[],c.AreaStr="",1==e.length?(_(e).each(function(e){e.Selected=!0}),0==c.IsAutoSetPosition&&c.toggleForArea(e[0])):1<e.length&&_(e).each(function(e){e.Selected=!1}),c.AreasList=e,c.IsAutoSetPosition&&(e.forEach(function(e){e.Position==a&&(c.itemsAreaStr.push(e.Region+"-"+e.Position),c.RepairParameters.IPositionIds.push(e.PositionId))}),c.AreaStr=c.itemsAreaStr.toString())}).error(function(e,t){}),c.IsAutoSetPosition&&c.EQ_close("")},c.toggleForArea=function(e){var t=c.RepairParameters.IPositionIds.indexOf(e.PositionId);-1<t?(c.RepairParameters.IPositionIds.splice(t,1),c.itemsAreaStr.splice(t,1)):(c.RepairParameters.IPositionIds.push(e.PositionId),c.itemsAreaStr.push(e.Region+"-"+e.Position)),c.AreaStr=c.itemsAreaStr.toString()},c.existsForArea=function(e,t){return-1<t.indexOf(e)},c.setSelect4Cause=function(){t(function(){$("#multi-append").data("select2").destroy(),$("#multi-append").off("change"),$("#multi-append").select2({placeholder:"请选择报修原因"}).change(function(){t(function(){c.RepairParameters.ICauseIds=_($("#multi-append").select2("val")).toArray(),0<c.RepairParameters.ICauseIds.length&&c.GetPriority();var e=$("#multi-append").select2("data");c.isOpenSetting=!1,_(e).each(function(e){"亚克力板坏"!=e.text&&"亚克力门板坏"!=e.text||($("#equipment_setting").modal("show"),c.isOpenSetting=!0)}),_(c.CauseList).each(function(e){_(e.children).each(function(e){e.ICauseIds==c.RepairParameters.ICauseIds&&(c.RepairParameters.Priority=e.Priority,c.RepairParameters.Emergency=e.Emergency,c.RepairParameters.Limitation=e.Limitation)})})},200)})},200)},c.GetCause=function(){c.RepairParameters.ICauseIds=[],c.itemsCauseStr=[],c.ICauses="",null!=c.RepairParameters.MaintainerId&&""!=c.RepairParameters.MaintainerId||(c.RepairParameters.MaintainerId="None"),d({url:ApiMapper.sApi+"/s/equipmentcause/"+c.RepairParameters.EquipmentId+"/"+c.RepairParameters.MaintainerId,method:"GET",contentType:"application/json",headers:{Passport:u.Passport},data:JSON.stringify({EquipmentTypeId:c.RepairParameters.EquipmentTypeId,EquipmentName:c.RepairParameters.EquipmentName,MaintainerId:c.RepairParameters.MaintainerId})}).success(function(e,t){c.CauseList=[];var a=e.children;_(a).each(function(e){1==e.Status&&c.CauseList.push(e)}),c.setSelect4Cause()}).error(function(e,t){})},c.createCause=function(){s.show({clickOutsideToClose:!0,scope:c,preserveScope:!0,template:'<md-dialog>  <md-dialog-content>    <h5 class="md-title text-center" style="font-size:14px;">新增原因</h5>    <input type="text" ng-model="Cause.value" placeholder="请输入...">  </md-dialog-content>  <div class="md-actions">    <md-button ng-click="cancelDialog()" class="md-primary">      取消    </md-button>    <md-button ng-click="closeDialog()" class="md-primary">      确定    </md-button>  </div></md-dialog>',controller:function(e,t){e.Cause={value:""},e.cancelDialog=function(){t.cancel()},e.closeDialog=function(){t.hide(e.Cause.value)}}}).then(function(e){if(null!=e&&""!=e){var t={Cause:e,EquipmentId:c.RepairParameters.EquipmentId,StoreUser:c.StoreUser};d({url:ApiMapper.sApi+"/s/equipmentcause/create",method:"Post",contentType:"application/json",headers:{Passport:u.Passport},data:JSON.stringify(t)}).success(function(e,t){c.IsInspection?c.getCause4Inspection():c.GetCause()}).error(function(e,t){alert(e.Messages)})}},function(){})},c.getCause4Inspection=function(){c.RepairParameters.CauseIds="",c.itemsCauseStr=[],c.ICauses="",d({url:ApiMapper.sApi+"/s/equipmentcause/inspect/"+c.RepairParameters.EquipmentId,method:"GET",contentType:"application/json",headers:{Passport:u.Passport}}).success(function(e,t){c.InspectionCauseList=[];var a=e.children;_(a).each(function(e){1==e.Status&&c.InspectionCauseList.push(e)})}).error(function(e,t){})},c.GetPriority=function(){c.PriorityList=[];var e={EquipmentTypeClass:c.RepairParameters.EquipmentTypeClass,EquipmentId:c.RepairParameters.EquipmentId,MaintainerId:c.RepairParameters.MaintainerId,CauseIds:c.RepairParameters.ICauseIds,IsSupportArea:c.RepairParameters.IsSupportArea};d({url:ApiMapper.sApi+"/s/priority",method:"POST",contentType:"application/json",headers:{Passport:u.Passport},data:JSON.stringify(e)}).success(function(e,t){c.PriorityList=[],c.PriorityCount=0,_(e).each(function(e){e.EquipmentTypeClass!=c.RepairParameters.EquipmentTypeClass&&99!=e.EquipmentTypeClass||(e.ischecked=!1,c.PriorityCount+=1,c.PriorityList.push(e))}),-1==["eb296708-6fc6-43f0-b506-0ca0fa91e1cd","6c690014-2571-48db-ac5a-c6ba2572a3bb","f96f98e2-38f9-456a-9813-82d899536a82","C4B0E179-8121-487E-AA63-59635ACF2447"].indexOf(u.CompanyId)&&(c.PriorityList[0].ischecked=!0,c.RepairParameters.PriorityId=c.PriorityList[0].PriorityId,c.RepairParameters.Priority=c.PriorityList[0].Priority,c.RepairParameters.Emergency=c.PriorityList[0].Emergency,c.RepairParameters.Limitation=c.PriorityList[0].Limitation)}).error(function(e,t){})},c.SetPriority=function(t){(_(c.PriorityList).each(function(e){e.ischecked=!1,e.PriorityId==t.PriorityId&&(e.ischecked=!0)}),-1<["308ffed8-d4a7-4ad5-8b61-6cce3c66cd06","eb296708-6fc6-43f0-b506-0ca0fa91e1cd","6c690014-2571-48db-ac5a-c6ba2572a3bb","f96f98e2-38f9-456a-9813-82d899536a82","C4B0E179-8121-487E-AA63-59635ACF2447"].indexOf(u.CompanyId))&&(-1!==t.Priority.indexOf("紧急")&&alert("请注意，紧急报修上门费比一般报修高！"));c.RepairParameters.PriorityId=t.PriorityId,c.RepairParameters.Priority=t.Priority,c.RepairParameters.Emergency=t.Emergency,c.RepairParameters.Limitation=t.Limitation},c.openAddEquipment=function(){r.open({animation:!0,templateUrl:"app/CaseList/SearchGroup/Case_search_equipment_add.html",controller:AddEquipmentCtr,size:"md",resolve:{UnitId:function(){return c.RepairParameters.UnitId},Unit:function(){return c.RepairParameters.Unit}}}).result.then(function(e){c.GetEquipment(c.RepairParameters.UnitId)},function(){})},c.chooseWhole=function(){wx.chooseImage({sourceType:["album","camera"],success:function(e){0<c.imagesList.WholeIds.length?Array.prototype.push.apply(c.imagesList.WholeIds,e.localIds):c.imagesList.WholeIds=e.localIds,c.imagesList.serverIds=[],c.$apply(),t(function(){_(c.imagesList.WholeIds).each(function(e,t){$("#wholePic"+t).attr({src:e,width:"72px",height:"72px"})})},500)}})},c.RemoveWhole=function(e){c.imagesList.WholeIds.splice(e,1)},c.chooseImage=function(){wx.chooseImage({sourceType:["album","camera"],success:function(e){0<c.imagesList.localIds.length?Array.prototype.push.apply(c.imagesList.localIds,e.localIds):c.imagesList.localIds=e.localIds,c.imagesList.serverIds=[],c.$apply(),t(function(){_(c.imagesList.localIds).each(function(e,t){$("#advPic"+t).attr({src:e,width:"72px",height:"72px"})})},500)}})},c.RemoveImg=function(e){c.imagesList.localIds.splice(e,1)},c.startRecord=function(){wx.startRecord({success:function(e){c.isStart=!0,c.$apply()}})},c.stopRecord=function(){wx.stopRecord({success:function(e){c.isStart=!1,c.Record.localId=e.localId,c.$apply()}})},wx.onVoiceRecordEnd({complete:function(e){c.Record.localId=e.localId,alert("录音时间已超过一分钟")}}),c.playVoice=function(){if(c.isplayVoice=!c.isplayVoice,c.isplayVoice){if(""==c.Record.localId)return void alert("请先录音！");wx.playVoice({localId:c.Record.localId}),wx.onVoicePlayEnd({success:function(e){c.isplayVoice=!1}})}else wx.pauseVoice({localId:c.Record.localId})},c.pauseVoice=function(){wx.pauseVoice({localId:c.Record.localId})},c.stopVoice=function(){wx.stopVoice({localId:c.Record.localId})},wx.onVoicePlayEnd({success:function(e){c.isplayVoice=!1}}),c.UpdateRecord=function(){wx.uploadVoice({localId:c.Record.localId,success:function(e){c.Record.serverId=e.serverId}})},c.CloseBrowser=function(){wx.closeWindow()},c.SetClosedNo=function(e){for(var t="",a=0;a<e;a++)t+=Math.floor(10*Math.random());return t},c.RepairParameters.ClosedNo=c.SetClosedNo(4),c.onLoad01=!0,c.onLoad02=!0;var p=0,m=c.imagesList.allIds.length;c.uploadImageIds={},c.upload=function(){setTimeout(function(){var e=c.uploadImageIds[c.imagesList.allIds[p]];if(void 0===e||""===e){var t=c.imagesList.allIds[p].toString();-1!=t.indexOf("wxlocalresource")&&(t=t.replace("wxlocalresource","wxLocalResource")),wx.uploadImage({localId:t,isShowProgressTips:1,success:function(e){e.id=e.serverId.toUpperCase(),c.uploadImageIds[c.imagesList.allIds[p]]=e.serverId,p++,c.imagesList.serverIds.push(e.serverId),c.RepairParameters.ImageMediaIds.push(e.serverId),c.MediasParamenter.Medias.image.push(e.serverId),p<m?c.upload():(c.onLoad01=!1,c.Submit_Repair())},fail:function(e){c.imagesList.serverIds=[],c.RepairParameters.ImageMediaIds=[],c.MediasParamenter.Medias.image=[],alert("上传图片发生服务器错误！ ")}})}else p++,c.imagesList.serverIds.push(e),c.RepairParameters.ImageMediaIds.push(e),c.MediasParamenter.Medias.image.push(e),p<m?c.upload():(c.onLoad01=!1,c.Submit_Repair())},100)},c.uploadimages=function(){c.onLoad01&&(c.imagesList.serverIds=[],c.MediasParamenter.Medias.image=[],c.RepairParameters.ImageMediaIds=[],p=0,m=c.imagesList.allIds.length,c.upload())},c.uploadVoice=function(){c.onLoad02&&wx.uploadVoice({localId:c.Record.localId,isShowProgressTips:1,success:function(e){c.Record.serverId=e.serverId,c.onLoad02=!1,c.RepairParameters.VoiceMediaId=c.Record.serverId,c.MediasParamenter.Medias.voice=[],c.MediasParamenter.Medias.voice.push(c.Record.serverId),c.Submit_Repair()},fail:function(e){c.RepairParameters.VoiceMediaId=[],c.MediasParamenter.Medias.voice=[],alert("上传发生服务器错误！ ")}})},c.LoadMedias=function(e){c.MediasParamenter.Key=e,d({url:ApiMapper.wxApi+"/wx/files/"+c.AppId,method:"POST",contentType:"application/json",headers:{Passport:u.Passport},data:c.MediasParamenter}).success(function(e){if("Saved"!=e)return c.isSubmit=!1,alert("报修失败！\n\r请联系580-440报修中心！"),!1;c.isSubmit=!1,alert("成功报修！\n\r单号："+c.CaseNo),c.CloseBrowser()}).error(function(e,t){c.isSubmit=!1,alert("报修失败！\n\r请联系580-440报修中心！")})},c.SubmitCount=0,c.Submit_Repair=function(){if(!c.IsInspection&&(""==c.RepairParameters.PriorityId||null==c.RepairParameters.PriorityId))return c.isSubmit=!1,alert("请选择报修原因及报修时限！"),!1;if(1==c.RepairParameters.IsRezPhotos){if(0==c.imagesList.WholeIds.length)return c.isSubmit=!1,alert("请上传报修整体照片！"),!1;if(0==c.imagesList.localIds.length)return c.isSubmit=!1,alert("请上传报修局部照片！"),!1}if(c.imagesList.allIds=c.imagesList.WholeIds.concat(c.imagesList.localIds),c.isSubmit=!0,0<c.imagesList.allIds.length&&c.onLoad01)c.uploadimages();else if(""!=c.Record.localId&&c.onLoad02)c.uploadVoice();else if(0==c.SubmitCount){if(c.SubmitCount=1,""==c.RepairParameters.UnitId||null==c.RepairParameters.UnitId)return c.isSubmit=!1,c.SubmitCount=0,alert("请选择报修单位！"),!1;if(""==c.RepairParameters.EquipmentCode||null==c.RepairParameters.EquipmentCode)return c.isSubmit=!1,c.SubmitCount=0,alert("请选择报修设备！"),!1;if(!c.IsInspection){if((0==c.RepairParameters.ICauseIds.length||null==c.RepairParameters.ICauseIds)&&""==c.RepairParameters.Description)return c.isSubmit=!1,c.SubmitCount=0,alert("请说明报修原因！"),!1;if(""==c.RepairParameters.PriorityId||null==c.RepairParameters.PriorityId)return c.isSubmit=!1,c.SubmitCount=0,alert("请选择维修时限！"),!1}if(c.IsInspection){if(""==c.RepairParameters.CauseIds)return c.isSubmit=!1,alert("请选择保养类型！"),!1;if(""==c.RepairParameters.EstArrivalTime)return c.isSubmit=!1,alert("请选择保养预计到场时间！"),!1;c.RepairParameters.EstArrivalTime=FormatDateTime(c.RepairParameters.EstArrivalTime);var e=$('input[name="EstArrivalDate"]').val(),t=(r=new Date(c.RepairParameters.EstArrivalTime)).getHours(),a=r.getMinutes(),i=r.getSeconds();c.RepairParameters.EstArrivalTime=e+" "+t+":"+a+":"+i}c.isOpenSetting&&(c.RepairParameters.Description=c.RepairParameters.Description+"\n\r"+c.SettingStr);var r,s=(r=new Date).getFullYear(),n=r.getMonth()+1,o=r.getDate();t=r.getHours(),a=r.getMinutes(),i=r.getSeconds();c.RepairParameters.RequestTime=s+"/"+n+"/"+o+" "+t+":"+a+":"+i;var p="s/rez";c.IsInspection&&(p="s/inspect"),d({url:ApiMapper.sApi+"/"+p,method:"POST",contentType:"application/json",headers:{Passport:u.Passport},data:c.RepairParameters}).success(function(e){if(1!=e.Receipt.StatusCode)return c.isSubmit=!1,c.SubmitCount=0,alert("报修失败！\n\r请联系580-440报修中心！"),!1;0<c.imagesList.allIds.length||""!=c.Record.localId?(c.CaseNo=e.CaseNo,c.LoadMedias(e.RequisitionId)):(c.isSubmit=!1,alert("成功报修！\n\r单号："+e.CaseNo),c.CloseBrowser())}).error(function(e,t){c.SubmitCount=0,c.isSubmit=!1,alert(e.Messages)})}},c.toggleRight=function(e){a(e).toggle()},c.closeDenav=function(e){a(e).close()},c.store_close=function(e){a("Store").close().then(function(){""!=e&&(c.Unit=e.Unit,c.RepairParameters.Unit=e.Unit,c.RepairParameters.UnitId=e.UnitId,c.RepairParameters.EquipmentCode="",c.EquipmentName="",c.RepairParameters.ICauseIds=[],c.CauseList=[],c.itemsCauseStr=[],c.ICauses="",c.setSelect4Cause(),c.GetEquipment(c.RepairParameters.UnitId))})},c.EQ_close=function(e){a("Area").close().then(function(){c.RepairParameters.ICauseIds=[],c.setSelect4Cause()})},c.SetCauseIds=function(e){var t=c.RepairParameters.ICauseIds.indexOf(e.CauseId);-1<t?(c.RepairParameters.ICauseIds.splice(t,1),c.itemsCauseStr.splice(t,1)):(c.RepairParameters.ICauseIds.push(e.CauseId),c.itemsCauseStr.push(e.Cause)),c.ICauses=c.itemsCauseStr.toString()},c.SettingStr="",c.setSetting=function(){var a=!1,i=!1,r=!1,s=!1;c.isVerification=!0;var n=0;return c.SettingStr=c.EquipmentName+"\n\r",_(c.SettingInfo).each(function(e,t){0,null==e.nLong||""==e.nLong?n+=1:isNaN(e.nLong)&&(a=!0),null==e.nWidth||""==e.nWidth?n+=1:isNaN(e.nWidth)&&(i=!0),null==e.nHeight||""==e.nHeight?n+=1:isNaN(e.nHeight)&&(r=!0),null==e.nCount||""==e.nCount?n+=1:isNaN(e.nCount)&&(s=!0),0<n&&n<4?(alert("请输入全部尺寸参数！"),c.isVerification=!1):4==n?1==c.SettingInfo.length?(alert("必须要有一种尺寸的亚克力板！"),c.isVerification=!1):c.SettingInfo.splice(t,1):c.SettingStr=c.SettingStr+"\n\r 长("+e.nLong+")mmX宽("+e.nWidth+")mmX厚("+e.nHeight+")mmX"+e.nCount}),a?(alert("长度必须是数字！"),!1):i?(alert("宽度必须是数字！"),!1):r?(alert("厚度必须是数字！"),!1):s?(alert("数量必须是数字！"),!1):(c.isShowSetting=!0,void(c.isVerification&&$("#equipment_setting").modal("hide")))},c.confirmAddSetting=function(e){1==parseInt(e)?(c.SettingInfo.push({nCount:null,nHeight:null,nWidth:null,nLong:null}),$("#confirmAddSetting").modal("hide")):($("#confirmAddSetting").modal("hide"),c.setSetting()),c.showConfirm=!1,$("#equipment_setting").css({"z-index":1050})},c.showConfirmModal=function(){c.showConfirm=!0,$("#equipment_setting").css({"z-index":99}),$("#confirmAddSetting").modal("show")},c.removeItem4Setting=function(e){1<c.SettingInfo.length?c.SettingInfo.splice(e,1):alert("必须要有一种尺寸的亚克力板！")}}]);
//# sourceMappingURL=Apply.js.map

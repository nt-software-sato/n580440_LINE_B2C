"use strict";WeChat.controller("QuickApplyCtrl",["$scope","$http","$q","$cookies","i18n",function(s,o,a,e,t){s.AppId=ApiMapper.AppId,s.OpenId=window.localStorage.getItem(s.AppId),s.UrlStr=$(location).attr("search")||"Unknown","Unknown"!=s.UrlStr&&(s.RedirectUri=decodeURIComponent(s.UrlStr.split("?redirect_uri=")[1]),s.RedirectUri=s.RedirectUri.replace("&","?"),s.Code=decodeURIComponent(s.UrlStr.split("?code=")[1])),s.getOpenId=function(){if(null==s.OpenId||null==s.OpenId||"null"==s.OpenId)if("undefined"==s.Code||null==s.Code){var e="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+s.AppId+"&redirect_uri="+encodeURIComponent(ApiMapper.PathStr+"QuickApply.html")+"&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect";location.href=e}else{var t=s.Code.split("&")[0],a=ApiMapper.wxApi+"/wx/r/openId?appId="+s.AppId+"&code="+t;o.get(a).success(function(e){console.log("openID: "+e),s.OpenId=e.openid,window.localStorage.setItem(s.AppId,s.OpenId)}).error(function(e){wx.closeWindow()})}},s.getOpenId(),s.Data={},o({url:ApiMapper.sApi+"/s/retail/equipment",method:"GET",contentType:"application/json"}).success(function(e){s.Data=e,console.log(s.Data),console.log("AppID: "+s.AppId,"\nOpenID: "+s.OpenId)}).error(function(e){console.log(e),alert(e.Messages)}),s.Load_WX=function(){wx.config({debug:!1,appId:s.AppId,timestamp:1437377735,nonceStr:"n580440",signature:window.localStorage.getItem(s.AppId+"_signature"),jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","translateVoice","startRecord","stopRecord","onRecordEnd","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard"]}),wx.error(function(e){o({url:ApiMapper.wxApi+"/wx/r/ticket/"+s.AppId,method:"GET",cache:!1,contentType:"application/json"}).success(function(e){var t=e;window.localStorage.setItem(s.AppId+"_ticket",t);var a="jsapi_ticket="+t+"&noncestr=n580440&timestamp=1437377735&url="+window.location.href;window.localStorage.setItem(s.AppId+"_signature",hex_sha1(a)),s.Load_WX()})})},s.Load_WX(),s.startRecord=function(){s.isRecord="stopRecord",wx.startRecord({success:function(e){s.isStart=!0,s.$apply()}}),wx.onVoiceRecordEnd({complete:function(e){s.isRecord="playVoice",s.isStart=!1,s.setData.localId=e.localId,s.$apply()}})},s.stopRecord=function(){s.isRecord="playVoice",wx.stopRecord({success:function(e){s.isStart=!1,s.setData.localId=e.localId,s.$apply()}})},s.playVoice=function(){s.isRecord="pauseVoice",wx.playVoice({localId:s.setData.localId})},s.pauseVoice=function(){s.isRecord="playVoice",wx.pauseVoice({localId:s.setData.localId})},s.BDpos="",s.latitude="",s.longitude="",s.getLocation=function(){s.isgetLocationLoading=!0,wx.getLocation({type:"wgs84",success:function(e){s.latitude=e.latitude,s.longitude=e.longitude,setTimeout(function(){var e=new BMap.Point(s.longitude,s.latitude),t=new BMap.Convertor,a=[];a.push(e),t.translate(a,1,5,s.translateCallback)},1500)}}),s.translateCallback=function(e){0===e.status?s.BDpos=new BMap.Point(e.points[0].lng,e.points[0].lat):(s.isgetLocationLoading=!1,alert(t.t("20052")),s.$apply()),(new BMap.Geocoder).getLocation(s.BDpos,function(e){e?(s.setData.address=e.address,s.isgetLocationLoading=!1,alert(t.t("20053"))):(s.isgetLocationLoading=!1,alert(t.t("20052"))),s.$apply()})}},s.setData={species:"",type:"",time:"",localId:"",serverId:"",reason:"",reasonSelect:"",address:"",userName:"",userTel:""},s.keyData={Code:"",ExpireTime:"",Passcode:""},s.setRepairData={ICauseIds:[],ICallInOrOut:11,RequisitionNote:{},Source:4,UserId:"",UnitId:"TSHLJ_C",Unit:"",Level2Name:"",Level3Name:"",EquipmentId:"",IPositionIds:[],Description:"",CauseIds:"",StrongholdInfo:"",OpenID:s.OpenId,Brand:"",EstArrivalTime:"",UserName:"",Address:""},s.MediasParamenter={Key:"",FileSoure:40,Medias:{image:[],voice:[]}},s.isShow=1,s.isHideText=!0,s.setDateInit="",s.setTimeInit="",s.isToday=null,s.timeOption="",s.isStart=!1,s.isRecord="startRecord",s.selectorEquipmentName="",s.selectorBrand="",s.selectorIndex="",s.selectorEquipmentSubTypeId="",s.CaseNo="",s.passport="",s.addSpecies=function(e,t){s.setData.species=e.EquipmentId,s.selectorEquipmentName=e.EquipmentName,s.selectorEquipmentSubTypeId=e.EquipmentSubTypeId,s.selectorIndex=t,s.isShow+=1},s.addType=function(e){s.setData.type=e,s.selectorBrand=e,s.isShow+=1},s.timeSwitch=function(){return""==s.setTimeInit||""==s.setDateInit},setTimeout(function(){var a=new Date((new Date).valueOf()-864e5);$(".datepicker").pickadate({disable:[{from:[0,0,0],to:a}],onSet:function(e){s.isToday=Math.floor(new Date(e.select)-Math.floor(new Date));var t=$(".timepicker").pickatime().pickatime("picker");t.set("disable",!1),s.isToday<=0?t.set("disable",[{from:[0,0,0],to:a}]):t.set("disable",[]),s.$apply()}})},0),s.addTime=function(){s.setData.time=s.setDateInit+s.setTimeInit,s.isShow+=1},s.addReason=function(e){s.setData.reason=e,s.isHideText=!s.isHideText},s.resetRecord=function(){s.isRecord="startRecord",s.setData.localId=""},s.causeDisable=function(){var e=""==s.setData.reason||null==s.setData.reason,t=""==s.setData.reasonSelect,a=""==s.setData.localId;return e&&t&&a},s.sendTelNum=function(){o({url:ApiMapper.sApi+"/s/retail/passcode",method:"POST",contentType:"application/json",data:{PhoneNo:s.setData.userTel}}).success(function(e){s.keyData.Code=e.Code,s.keyData.ExpireTime=e.ExpireTime,setTimeout(function(){alert(t.t("20054")),console.log(s.keyData)},500)}).error(function(e){setTimeout(function(){""==s.setData.userTel||null==s.setData.userTel?alert(t.t("20055")):alert(t.t("20056"))},500)})},s.uesrFilter=function(){var e=""==s.setData.address,t=""==s.setData.userName,a=""==s.keyData.Passcode,o=!/^\d+$/.test(s.setData.userTel);return e||t||a||o},s.addUserInfo=function(e,t,a){s.setData.address=e,s.setData.userName=t,s.setData.userTel=a,s.setRepairData.ICauseIds.push(s.setData.reasonSelect),s.setRepairData.CauseIds=s.setData.reasonSelect,s.setRepairData.UserId=s.setData.userTel,s.setRepairData.EquipmentId=s.setData.species,s.setRepairData.Description=s.setData.reason,s.setRepairData.Brand=s.setData.type,s.setRepairData.EstArrivalTime=s.setData.time,s.setRepairData.UserName=s.setData.userName,s.setRepairData.Address=s.setData.address,console.log(s.setData),console.log(s.setRepairData),o({url:ApiMapper.sApi+"/s/retail/passcode/confirm",method:"POST",contentType:"application/json",data:s.keyData}).success(function(e){s.stratPromise()}).error(function(e){alert(e.Messages)})},s.uploadVoicePromise=function(){var t=a.defer(),e=t.promise;return""==s.setData.localId&&t.resolve("success"),wx.uploadVoice({localId:s.setData.localId,isShowProgressTips:1,success:function(e){s.setData.serverId=e.serverId,t.resolve("success")}}),e},s.LoadMedias=function(e){s.MediasParamenter.Key=e,s.MediasParamenter.Medias.voice.push(s.setData.serverId),o({url:ApiMapper.wxApi+"/wx/files/"+s.AppId,method:"POST",contentType:"application/json",headers:{Passport:s.passport},data:s.MediasParamenter}).success(function(e){"Saved"!=e?alert(t.t("20057")+"\n\r"+t.t("20007")):(alert(t.t("20058")+"\n\r"+t.t("20059")+"："+s.CaseNo),wx.closeWindow())}).error(function(){alert(t.t("20057")+"\n\r"+t.t("20007"))})},s.getPassportApi=function(){var t=a.defer(),e=t.promise;return o({url:ApiMapper.wxApi+"/wx/reg/retail/"+s.OpenId+"/"+s.AppId,method:"PATCH",contentType:"application/json",data:{PhoneNo:s.setData.userTel,UserName:s.setData.userName}}).success(function(e){console.log(e),s.passport=e.o[0].Passport,s.setRepairData.Unit=e.o[0].Unit,console.log("要post給後端的資料"),console.log(JSON.stringify(s.setRepairData)),t.resolve("success")}).error(function(e){alert(e.Messages)}),e},s.addRepairApi=function(){o({url:ApiMapper.sApi+"/s/rez",method:"POST",contentType:"application/json",headers:{Passport:s.passport},data:JSON.stringify(s.setRepairData)}).success(function(e){console.log(e),""!=s.setData.serverId?(s.CaseNo=e.CaseNo,s.LoadMedias(e.RequisitionId)):(alert(t.t("20058")+"\n\r"+t.t("20059")+"："+e.CaseNo),wx.closeWindow())}).error(function(e){console.log("加入報修單錯誤"),alert(e.Message)})},s.stratPromise=function(){s.uploadVoicePromise().then(function(e){if("success"==e)return console.log("serverID: "+s.setData.serverId),s.getPassportApi()}).then(function(e){"success"==e&&s.addRepairApi()})}}]);
//# sourceMappingURL=QuickApply.js.map

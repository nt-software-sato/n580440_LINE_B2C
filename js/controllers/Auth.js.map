{"version":3,"sources":["controllers/Auth.js"],"names":["WeChat","controller","$scope","$http","$location","$window","$cookies","$q","md5","i18n","isShowLogin","bind2Store","isUsed","QRCodeStr","username","userpassword","passCode","UserInfo","UnitId","UserName","UserId","SigninType","Contacts","Type","Info","isUnitManager","UnitInfo","Unit","UserInfo02","AppId","ApiMapper","console","log","undefined","window","localStorage","setItem","UrlStr","$","location","attr","decodeURIComponent","split","RedirectUri","replace","PathStr","getItem","GetAccountInfo","lineApi","OpenId","url","method","data","success","Code","o","Id","Passport","Name","CompanyId","StoreUser","ExpiredTime","Updated","parseInt","ValidtorTime","ChangePassword","href","error","res","getOpenId","AccountSubmit","val","alert","submitUrl","wxApi","value","Password","contentType","StatusCode","Messages"],"mappings":"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","file":"Auth.js","sourcesContent":["WeChat.controller('AuthCtrl', ['$scope', '$http', '$location', '$window', '$cookies', '$q', 'md5', 'i18n',\r\n  function($scope, $http, $location, $window, $cookies, $q, md5, i18n) {\r\n    $scope.isShowLogin = false;\r\n    $scope.bind2Store = false;\r\n    $scope.isUsed = false;\r\n    $scope.QRCodeStr = '';\r\n    $scope.username = '';\r\n    $scope.userpassword = '';\r\n    $scope.passCode = '';\r\n    $scope.UserInfo = {\r\n      UnitId: '',\r\n      UserName: '',\r\n      UserId: '',\r\n      SigninType: 2,\r\n      Contacts: [{\r\n        Type: 1,\r\n        Info: '',\r\n        UserId: ''\r\n      }]\r\n    };\r\n    $scope.isUnitManager = {\r\n      value: 0\r\n    };\r\n    $scope.UnitInfo = {\r\n      Unit: '',\r\n      UnitId: '',\r\n      passCode: ''\r\n    };\r\n    $scope.UserInfo02 = {\r\n      UserId: '',\r\n      Password: ''\r\n    };\r\n    $scope.AppId = ApiMapper.AppId;\r\n    // $scope.AppId = \"wxb04d43e40105795a\";\r\n    console.log(\"目前AppID: \" + $scope.AppId);\r\n    $scope.isOurAppId = false;\r\n    //不是正式機的APPID也不是測試機的AppId 就是別人的AppId\r\n    if ($scope.AppId == 'wxb04d43e40105795a' || $scope.AppId == 'wxb39ebe28ba7036a5') {\r\n      $scope.isOurAppId = true;\r\n    }\r\n    if ($scope.AppId == undefined || $scope.AppId == null) {\r\n      $scope.AppId = ApiMapper.AppId;\r\n      window.localStorage.setItem('b2c_appId', $scope.AppId);\r\n      window.localStorage.setItem('RedirectUri', 'account_success.html');\r\n    }\r\n    $scope.UrlStr = $(location).attr('search') || 'Unknown';\r\n    if ($scope.UrlStr != 'Unknown') {\r\n      $scope.RedirectUri = decodeURIComponent($scope.UrlStr.split('?redirect_uri=')[1]);\r\n      $scope.RedirectUri = $scope.RedirectUri.replace('&', '?');\r\n      $scope.Code = decodeURIComponent($scope.UrlStr.split('?code=')[1]);\r\n    }\r\n    var RedirectUri = ApiMapper.PathStr + 'account_success.html';\r\n    $scope.OpenId = window.localStorage.getItem($scope.AppId);\r\n    //获取帐号绑定信息\r\n    $scope.GetAccountInfo = function() {\r\n      $http({\r\n        url: ApiMapper.lineApi + '/line/s/signin/' + $scope.OpenId,\r\n        method: 'GET'\r\n      }).success(function(data) {\r\n        if (data.Code == 100) {\r\n          var UserInfo = data.o[0];\r\n          $cookies.UserId = UserInfo.Id;\r\n          $cookies.Passport = UserInfo.Passport;\r\n          $cookies.UnitId = UserInfo.UnitId;\r\n          $cookies.Unit = UserInfo.Unit;\r\n          $cookies.UserName = UserInfo.Name;\r\n          $cookies.CompanyId = UserInfo.CompanyId;\r\n          $cookies.StoreUser = UserInfo.StoreUser;\r\n          $cookies.ExpiredTime = UserInfo.ExpiredTime;\r\n          $cookies.Updated = UserInfo.Updated;\r\n          window.localStorage.setItem('Passport', UserInfo.Passport);\r\n          if ($scope.ValidtorTime(UserInfo.ExpiredTime, $scope.GetNow()) && parseInt(UserInfo.StoreUser) == 1 && parseInt(UserInfo.Updated) == 0) {\r\n            location.replace(ApiMapper.PathStr + 'confirm_PassCode.html');\r\n          } else {\r\n            if (UserInfo.ChangePassword == 1) {\r\n              RedirectUri = ApiMapper.PathStr + 'forget_Password.html';\r\n              location.replace(RedirectUri);\r\n            } else {\r\n              window.location.href = RedirectUri;\r\n            }\r\n          }\r\n        } else {\r\n          if (parseInt(data.Code) === 209) {\r\n            //wx.closeWindow();\r\n            RedirectUri = ApiMapper.PathStr + 'noService.html';\r\n            location.replace(RedirectUri);\r\n          } else {\r\n            $scope.isShowLogin = true;\r\n          }\r\n        }\r\n      }).error(res => {\r\n        $scope.isShowLogin = true;\r\n      });\r\n    };\r\n    $scope.getOpenId = function() {\r\n      if ($scope.UrlStr.split(\"?redirect_uri=\")[1] == undefined) {\r\n        $scope.GetAccountInfo();\r\n      } else {\r\n        RedirectUri = decodeURIComponent($scope.UrlStr.split(\"?redirect_uri=\")[1]);\r\n        $scope.GetAccountInfo();\r\n      }\r\n    }\r\n    //在網頁開發時記得把這一串註解起來 不然會說在微信才能用\r\n    $scope.getOpenId();\r\n    //網頁開發時打開 使用手機時註解\r\n    //$scope.GetAccountInfo();\r\n    //填完帳戶資料,點選送出後透過patch將資訊傳至後臺\r\n    $scope.AccountSubmit = function() {\r\n      //$scope.message 為 $scope.userpassword 加密後資料\r\n      $scope.username = $('[name=username]').val();\r\n      //alert(JSON.stringify($scope.UserInfo02));\r\n      if (!$scope.bind2Store) {\r\n        if ($scope.UserInfo02.UserId == '' || $scope.UserInfo02.Password == '') {\r\n          alert(i18n.t(\"20050\"));\r\n          return false;\r\n        }\r\n        $scope.submitUrl = ApiMapper.wxApi + '/wx/reg/' + $scope.OpenId + '/' + $scope.AppId;\r\n        $scope.UserInfo = {\r\n          Id: $scope.UserInfo02.UserId,\r\n          Password: md5.createHash($scope.UserInfo02.Password || '')\r\n        };\r\n      } else {\r\n        if ($scope.UserInfo.UnitId == '' || $scope.UserInfo.UserName == '' || $scope.UserInfo.UserId == '' || $scope.UserInfo.Contacts[0].Info == '' || $scope.UnitInfo.passCode == '') {\r\n          alert(i18n.t(\"20051\"));\r\n          return false;\r\n        }\r\n        $scope.submitUrl = ApiMapper.wxApi + '/wx/reg/' + $scope.OpenId + '/' + $scope.AppId + '/' + $scope.UnitInfo.passCode + '?isUnitManager=' + $scope.isUnitManager.value;\r\n        $scope.UserInfo.Contacts[0].UserId = $scope.UserInfo.UserId;\r\n        $scope.UserInfo.HrCode = $scope.UserInfo.UnitId;\r\n      }\r\n      //alert(JSON.stringify($scope.UserInfo));\r\n      //呼叫內部API\r\n      $http({\r\n        url: $scope.submitUrl,\r\n        data: $scope.UserInfo,\r\n        contentType: 'application/json',\r\n        method: 'PATCH'\r\n      }).success(function(data) {\r\n        //将用户数据写入Cookies\r\n        if (data.StatusCode == 1) {\r\n          $scope.GetAccountInfo();\r\n        } else {\r\n          if (parseInt(data.Code) === 209) {\r\n            alert(data.Messages);\r\n            wx.closeWindow();\r\n          }\r\n        }\r\n      }).error(function(data) {\r\n        alert(data.Messages);\r\n        if (parseInt(data.Code) === 209) {\r\n          wx.closeWindow();\r\n        }\r\n      });\r\n    };\r\n  }\r\n]);"]}
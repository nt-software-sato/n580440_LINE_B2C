"use strict";WeChat.controller("AllotListCtrl",["$scope","$http","$timeout","$cookies","$filter","$sce","$mdSidenav",function(s,r,a,n,t,i,o){s.StoreUser=n.StoreUser,s.AppId=ApiMapper.AppId,s.OpenId=window.localStorage.getItem(s.AppId),s.PageCounts=0,s.currentPage=1,s.TimesForLock=0,s.isLoading=!0,s.isShowMore=!1,s.List=[],s.Select2Data=[],s.Select2Data01=[],s.SelectedList01=[],s.Select2SelectedList=[],s.StoreSelectedList=[],s.RequestTime={StartDate:null,EndDate:null},s.RequisitionStatus={ToBeDelivery:!1,AlreadyDelivery:!1,AlreadyAccept:!1,Cancel:!1},s.SearhParams={StageId:[0,1,2,3,4]};var c,l="list",d=["发货","师傅已取件"],u=["unknown","设备调拨","返厂维修"],S=["待发货","已发货","已收货","已取消","已返还"],p=["申请","发货","收货","取消","返还"];s.deliberatelyTrustDangerousSnippet=function(e){return i.trustAsHtml(e)},s.Search_Time=function(e){100==s.TimesForLock?(a.cancel(c),s.TimesForLock=0,s.SearchList(1)):(s.TimesForLock=s.TimesForLock+1,c=a(function(){s.Search_Time(e)},1))},s.OpenDetail=function(e){s.moveOrder=e.MoveOrder,s.moveOrder.CurrentStepName=S[e.MoveOrder.CurrentStep],s.moveOrder.MoveTypeName=u[e.MoveOrder.MoveType],s.moveOrder.NextStepShow=[],s.moveOrder.isSubmit=!1,_.each(s.moveOrder.NextStep,function(e){var t={stepId:e,stepName:""};1===e?t.stepName=d[s.moveOrder.MoveType-1]:2===e?t.stepName="收货":3===e&&(t.stepName="取消"),s.moveOrder.NextStepShow.push(t)}),s.moveHist=_.forEach(e.MoveOrderHistories,function(e){e.tlType="tl-item",e.tlSubType="tl-wrap b-info",e.StepTime=p[e.Step]}),"list"==l&&(o("MoveDetail").open(),l="detail")},s.GetMoveOrderDetail=function(e){r({url:ApiMapper.sApi+"/s/moveOder/detail/"+e,method:"GET",contentType:"application/json",headers:{Passport:n.Passport}}).success(function(e){s.OpenDetail(e)}).error(function(e){})};var e=getQueryString("moveOrderId");e&&s.GetMoveOrderDetail(e),s.SetParams=function(e){s.SearhParams.StageId=[],99===parseInt(e)?s.SearhParams.StageId=[0,1,2,3]:s.SearhParams.StageId.push(e),s.SearchList(1)},s.SearchList=function(e){s.isShowMore=!1,0<parseInt(e)?s.currentPage=e:s.currentPage=1,s.currentPage<=1&&(s.isLoading=!0),s.SearhParams.RequestTime=[],null!=s.RequestTime.StartDate&&s.SearhParams.CreatedTime.push(s.RequestTime.StartDate),null!=s.RequestTime.EndDate&&s.SearhParams.CreatedTime.push(s.RequestTime.EndDate),r({url:ApiMapper.sApi+"/s/moveOder/search/"+s.currentPage,method:"POST",cache:!1,contentType:"application/json",headers:{Passport:n.Passport},data:JSON.stringify(s.SearhParams)}).success(function(e){1==s.currentPage&&(s.List=[]),0<e[2]?(s.isShowDetail=!0,s.PageCounts=parseInt(e[0]),s.isShowMore=1<s.PageCounts,s.currentPage==s.PageCounts?s.isShowMore=!1:s.isShowMore=!0,_.each(e[1],function(i){i.MoveOrder.NextStepShow=[],i.MoveOrder.isSubmit=!1,null==i.MoveOrder.RequisitionId||""==i.MoveOrder.RequisitionId?i.MoveOrder.isLinkRepair=!1:(i.MoveOrder.SourceUnit==n.Unit&&1==n.StoreUser||0==n.StoreUser)&&(i.MoveOrder.isLinkRepair=!0),_.each(i.MoveOrder.NextStep,function(e){var t={stepId:e,stepName:""};1===e?t.stepName=d[i.MoveOrder.MoveType-1]:2===e?t.stepName="收货":3===e&&(t.stepName="取消"),i.MoveOrder.NextStepShow.push(t)}),i.MoveOrder.isEdit=!0,0==i.MoveOrder.CurrentStep?(i.MoveOrder.isEdit=!0,i.MoveOrder.CurrentStepName="待发货"):1==i.MoveOrder.CurrentStep?(i.MoveOrder.isEdit=!0,i.MoveOrder.CurrentStepName="已发货"):2==i.MoveOrder.CurrentStep?(i.MoveOrder.isEdit=!1,i.MoveOrder.CurrentStepName="已收货"):3==i.MoveOrder.CurrentStep&&(i.MoveOrder.isEdit=!1,i.MoveOrder.CurrentStepName="已取消"),s.List.push(i)})):(s.isShowDetail=!1,s.isShowMore=!1),s.isLoading=!1}).error(function(){s.isLoading=!1})},s.LoadMore=function(){s.currentPage=s.currentPage+1,s.SearchList(s.currentPage),s.currentPage==s.PageCounts&&(s.isShowMore=!1)},s.SetCaseCode=function(){a.cancel(c),a(function(){s.TimesForLock=0,s.Search_Time("S")},100)},s.SearchList(1),s.GetStore=function(){r({url:ApiMapper.sApi+"/s/unit/maps",method:"GET",cache:!1,contentType:"application/json",headers:{Passport:n.Passport}}).success(function(e){s.StoreList=[],s.Unitdata=e,_(s.Unitdata[1]).each(function(i){s.StoreList.push({Id:i.UnitId,Text:i.Unit,isSelected:!1,Level1:"",Level2:"",UnitLevel:10}),_(s.Unitdata[2]).each(function(t){t.Level2==i.UnitId&&(s.StoreList.push({Id:t.UnitId,Text:"　"+t.Unit,isSelected:!1,Level1:"",Level2:"",UnitLevel:20}),_(s.Unitdata[3]).each(function(e){e.Level3==t.UnitId&&s.StoreList.push({Id:e.UnitId,Text:"　　"+e.Unit,isSelected:!1,Level1:i.UnitId,Level2:t.UnitId,UnitLevel:100}),e.UnitId==n.UnitId&&(s.SearhParams.UnitIds.push(e.UnitId),s.UnitIds.push(e.UnitId),s.Unit=e.Unit,s.Select2List=[{Id:e.UnitId,Text:e.Unit}],s.StoreSelectedList=s.Select2List,s.SelectedList01=s.Select2List)}))})}),s.Select2Data01=s.StoreList})},s.openFilterRight=function(){o("FilterRight").toggle(),s.GetStore()},s.closeDenav=function(e){o(e).close().then(function(){o("MoveDetail").close().then(function(){l="list"})})},s.SetParams=function(e){s.RequisitionStatus[e]=!s.RequisitionStatus[e],s.SearhParams.StageId=[],setTimeout(function(){s.RequisitionStatus.ToBeDelivery&&s.SearhParams.StageId.push(0),s.RequisitionStatus.AlreadyDelivery&&s.SearhParams.StageId.push(1),s.RequisitionStatus.AlreadyAccept&&s.SearhParams.StageId.push(2),s.RequisitionStatus.Cancel&&s.SearhParams.StageId.push(3),s.RequisitionStatus.AlreadyReturn&&s.SearhParams.StageId.push(4)},100)},s.LoadMnti=function(e){s.tabName="单位",s.tabId="Store",s.Select2Data=s.StoreList,0<s.SelectedList01.length?s.Select2List=s.SelectedList01:s.Select2List=[{Id:"",Text:""}]},s.clearSelect2Values4Item=function(){_(s.Select2List).each(function(e,t){e.Id="",e.Text=""}),_(s.Select2Data).each(function(e){e.isSelected=!1}),"Store"==s.tabId?s.StoreList=s.Select2Data:"Maintainer"==s.tabId?s.pcompanyList=s.Select2Data:s.EquipmentList=s.Select2Data},s.loadSelect2Data4Item=function(){if("Store"==s.tabId){s.StoreSelectedList=_.uniq(s.SelectedList01),s.UnitIds=[];var e=[];_(s.StoreSelectedList).each(function(t){e.push(t.Text),_(s.Select2Data01).each(function(e){e.Id!=t.Id&&t.Id!=e.Level1&&t.Id!=e.Level2||s.UnitIds.push(e.Id)}),s.UnitIds.push(t.Id)}),s.Unit=e.toString(),s.MaintainerSelectedList=[],s.EquipmentSelectedList=[]}else"Maintainer"==s.tabId?s.MaintainerSelectedList=s.SelectedList02:s.EquipmentSelectedList=s.SelectedList03},s.isShowButton=function(e,t){var i=s.Select2List[t].Id;return"ADD"==e?""==i||0==t&&1<s.Select2List.length:0==t&&1==s.Select2List.length&&(""==i||null==i)},s.AddToSelect2=function(e){s.isShowButton("ADD",e)||s.Select2List.push({Id:"",text:""})},s.RemoveForSelect2=function(e){s.isShowButton("Delete",e)||(1<s.Select2List.length?s.Select2List.splice(e,1):(s.Select2List=[{Id:"",Text:""}],s.Select2Data01=[],s.SelectedList01=[]))},s.rSetSelect2Values=function(e){e.isSelected=!1,e.Text="",e.Id=""},s.SetFiterHighlight=function(r){s.Select2Data=[],_(s.StoreList).each(function(e){var t=e,i=e.Text;if(i=i.replace("<span style='color:red;'>",""),e.Text=i.replace("</span>",""),""!=r.Text&&0<=i.indexOf(r.Text)){var a="<span style='color:red;'>"+r.Text+"</span>";t.Text=i.replace(r.Text,a),s.Select2Data.push({Id:e.Id,Text:i.replace(r.Text,a)}),i=i.replace("<span style='color:red;'>",""),e.Text=i.replace("</span>","")}})},s.SetSelect2Values=function(e,t){$(".NT_side_footer").removeClass("unfixed"),e.isSelected=!e.isSelected;var i=s.Select2Data[t].Text;i=(i=(i=(i=i.replace("　","")).replace("　","")).replace("<span style='color:red;'>","")).replace("</span>",""),e.Text=i,e.Id=s.Select2Data[t].Id,a(function(){s.Select2Data01=s.Select2Data,s.SelectedList01=_.uniq(s.Select2List)},300)};s.clearSelect2Values=function(){s.RequestTime={StartDate:null,EndDate:null},s.RequisitionStatus={ToBeDelivery:!1,AlreadyDelivery:!1,AlreadyAccept:!1,Cancel:!1},s.SearhParams={StageId:[0,1,2,3]},s.Select2Data01=s.StoreList,s.StoreSelectedList=[],_(s.Select2List).each(function(e,t){e.Id="",e.Text=""}),_(s.Select2Data01).each(function(e){e.isSelected=!1}),_(s.SelectedList01).each(function(e){e.isSelected=!1}),s.Unit="",s.closeDenav("FilterRight"),s.SearchList(s.currentPage)},s.gotoSearch=function(){s.SearhParams.UnitIds=[];var e=[];_(s.StoreSelectedList).each(function(t){e.push(t.Text),_(s.StoreList).each(function(e){e.Id!=t.Id&&t.Id!=e.Level1&&t.Id!=e.Level2||s.SearhParams.UnitIds.push(e.Id)}),s.SearhParams.UnitIds.push(t.Id)}),s.Unit=e.toString(),s.closeDenav("FilterRight"),s.SearchList(s.currentPage)},s.addHistory4Allot=function(t,e,i){var a={MoveOrderId:t,StageId:e};r({url:ApiMapper.sApi+"/s/moveOder/history/create",method:"POST",contentType:"application/json",headers:{Passport:n.Passport},data:a}).success(function(e){"detail"==l&&s.GetMoveOrderDetail(t),s.SearchList(s.currentPage)}).error(function(e){s.isSubmit=!1,alert(e.Messages)})},s.GetRepairDetail=function(e){window.localStorage.setItem("DetailId",e),s.$broadcast("RepairList2Detail",e),o("RepairDetail").toggle(),s.RepairInfo={}},s.GetEquipmentpos=function(){if(null!=s.RepairInfo.IPositionIds){var t=s.RepairInfo.IPositionIds;""!=t&&r({url:ApiMapper.sApi+"/s/equipmentpos/"+s.RepairInfo.EquipmentId,method:"GET",contentType:"application/json",headers:{Passport:n.Passport},cache:!1}).success(function(e){s.Equipmentpos=_(e).filter(function(e){return 0<=t.indexOf(e.PositionId)})})}},s.getHistory=function(){r({url:ApiMapper.sApi+"/s/rez/history/"+s.RepairInfo.RequisitionId,method:"GET",contentType:"application/json",headers:{Passport:n.Passport}}).success(function(e){0<e.length&&(e=e.reverse(),s._TableData=e,_(s._TableData).each(function(e){e.ResponseTime=t("date")(new Date(e.ResponseTime),"yyyy/MM/dd HH:mm:ss")}),0<s._TableData.length&&(s.isTimeline=!0),console.log("值為"),console.log(s._TableData))})},s.GetUnitInfo=function(){r({url:ApiMapper.sApi+"/s/unit/"+Base64.encode(s.RepairInfo.UnitId),method:"GET",contentType:"application/json",headers:{Passport:n.Passport},cache:!1}).success(function(e){s.DeptInfo=e})},s.GetCheckinHistories=function(e){r({url:ApiMapper.sApi+"/s/checkin/"+e,method:"GET",contentType:"application/json",headers:{Passport:n.Passport}}).success(function(e){s.RepairInfo.CheckinHistories=[],_(e).each(function(e){e.Selected=!1}),s.RepairInfo.CheckinHistories=e})}}]);
//# sourceMappingURL=AllotList.js.map

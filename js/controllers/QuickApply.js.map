{"version":3,"sources":["controllers/QuickApply.js"],"names":["WeChat","controller","$scope","$http","$q","$cookies","i18n","AppId","ApiMapper","OpenId","window","localStorage","getItem","UrlStr","location","split","RedirectUri","replace","decodeURIComponent","undefined","getOpenId","Code","encodeURIComponent","PathStr","href","urlstr","newUrl","wxApi","CodeId","data","console","success","setItem","error","Data","sApi","url","method","log","alert","Messages","wx","config","debug","appId","timestamp","nonceStr","signature","jsApiList","cache","contentType","startRecord","onVoiceRecordEnd","complete","res","stopRecord","isRecord","isStart","setData","localId","ticket","hex_sha1","String1","Load_WX","pauseVoice","longitude","getLocation","isgetLocationLoading","latitude","setTimeout","ggPoint","Point","convertor","playVoice","translateCallback","$apply","BDpos","myGeo","BMap","Convertor","pointArr","push","translate","serverId","status","reason","points","lng","lat","userName","userTel","t","Geocoder","result","setRepairData","ICauseIds","address","RequisitionNote","Source","Level2Name","Level3Name","UserId","EstArrivalTime","UserName","Address","time","MediasParamenter","Key","FileSoure","Medias","image","voice","keyData","isShow","ExpireTime","isHideText","setTimeInit","timeOption","Unit","selectorEquipmentName","IPositionIds","selectorBrand","CauseIds","selectorIndex","OpenID","selectorEquipmentSubTypeId","CaseNo","addSpecies","setDateInit","sw","$","pickadate","from","isToday","inputpick","pickatime","index","speciesList","EquipmentId","EquipmentName","EquipmentSubTypeId","pick","addType","typeList","addTime","type","timeSwitch","Date","valueOf","disable","resetRecord","Math","floor","context","select","causeDisable","reasonSelect","set","text","key","Passcode","tel","reg","addUserInfo","Description","uesrFilter","uploadVoicePromise","mydefer","myPromise","promise","isShowProgressTips","species","Brand","LoadMedias","RequisitionId","headers","stratPromise","closeWindow","defer","getPassportApi","PhoneNo","JSON","addRepairApi","passport","Message","o","stringify","resolve","Passport","then"],"mappings":"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","file":"QuickApply.js","sourcesContent":["WeChat.controller('QuickApplyCtrl', ['$scope', '$http', '$q', '$cookies','i18n', function ($scope, $http, $q, $cookies,i18n) {\r\n\r\n  //取得openID\r\n  //流程是AppID(公眾號ID) > codeID(驗證碼) > openID(使用者在這個公眾號的ID) > (API) > 使用者資訊\r\n  $scope.AppId = ApiMapper.AppId;\r\n  $scope.OpenId = window.localStorage.getItem($scope.AppId);\r\n  $scope.UrlStr = $(location).attr(\"search\") || \"Unknown\";\r\n  if ($scope.UrlStr != \"Unknown\") {\r\n    $scope.RedirectUri = decodeURIComponent($scope.UrlStr.split(\"?redirect_uri=\")[1]);\r\n    $scope.RedirectUri = $scope.RedirectUri.replace(\"&\", \"?\");\r\n    $scope.Code = decodeURIComponent($scope.UrlStr.split(\"?code=\")[1]);\r\n  };\r\n  $scope.getOpenId = function () {\r\n    //如果沒有openID才去取得\r\n    if ($scope.OpenId == undefined || $scope.OpenId == null || $scope.OpenId == \"null\") {\r\n      if ($scope.Code == \"undefined\" || $scope.Code == undefined) { //判断地址是否有带Code\r\n        //這邊是微信登入取得網址 記得要把xxxxx.html改成當前的網頁\r\n        var urlstr = \"https://open.weixin.qq.com/connect/oauth2/authorize?appid=\" + $scope.AppId + \"&redirect_uri=\" + encodeURIComponent(ApiMapper.PathStr + \"QuickApply.html\") + \"&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect\";\r\n        location.href = urlstr;\r\n      } else {\r\n        //codeID也就是驗證碼\r\n        var CodeId = $scope.Code.split(\"&\")[0]; //從連結上面擷取code資料\r\n        var newUrl = ApiMapper.wxApi + \"/wx/r/openId?appId=\" + $scope.AppId + \"&code=\" + CodeId; //呼叫Gina API\r\n        //取得OpenID\r\n        $http.get(newUrl).success(function (data) {\r\n          console.log('openID: ' + data);\r\n          //alert(\"Code:\" + CodeId + \"|openid:\" + data.openid);\r\n          $scope.OpenId = data.openid;\r\n          window.localStorage.setItem($scope.AppId, $scope.OpenId);\r\n        }).error(function (data) {\r\n          wx.closeWindow();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  //進路網頁後呼叫API取得資料\r\n  //取得openId 記得最後開微信要打開\r\n  $scope.getOpenId();\r\n\r\n\r\n\r\n  $scope.Data = {};\r\n  $http({\r\n      url: ApiMapper.sApi + '/s/retail/equipment',\r\n      method: 'GET',\r\n      contentType: 'application/json'\r\n    })\r\n    .success(function (data) {\r\n      $scope.Data = data;\r\n      console.log($scope.Data);\r\n      console.log('AppID: ' + $scope.AppId, '\\n' + 'OpenID: ' + $scope.OpenId);\r\n    })\r\n    .error(function (error) {\r\n      console.log(error);\r\n\r\n      alert(error.Messages);\r\n    });\r\n\r\n  //设定微信调用\r\n  $scope.Load_WX = function () {\r\n    wx.config({\r\n      debug: false,\r\n      appId: $scope.AppId,\r\n      timestamp: 1437377735,\r\n      nonceStr: 'n580440',\r\n      signature: window.localStorage.getItem($scope.AppId + \"_signature\"),\r\n      jsApiList: [\r\n        'checkJsApi',\r\n        'onMenuShareTimeline',\r\n        'onMenuShareAppMessage',\r\n        'onMenuShareQQ',\r\n        'onMenuShareWeibo',\r\n        'hideMenuItems',\r\n        'showMenuItems',\r\n        'hideAllNonBaseMenuItem',\r\n        'showAllNonBaseMenuItem',\r\n        'translateVoice',\r\n        'startRecord',\r\n        'stopRecord',\r\n        'onRecordEnd',\r\n        'playVoice',\r\n        'pauseVoice',\r\n        'stopVoice',\r\n        'uploadVoice',\r\n        'downloadVoice',\r\n        'chooseImage',\r\n        'previewImage',\r\n        'uploadImage',\r\n        'downloadImage',\r\n        'getNetworkType',\r\n        'openLocation',\r\n        'getLocation',\r\n        'hideOptionMenu',\r\n        'showOptionMenu',\r\n        'closeWindow',\r\n        'scanQRCode',\r\n        'chooseWXPay',\r\n        'openProductSpecificView',\r\n        'addCard',\r\n        'chooseCard',\r\n        'openCard'\r\n      ]\r\n    });\r\n    wx.error(function (res) {\r\n      $http({\r\n        url: ApiMapper.wxApi + '/wx/r/ticket/' + $scope.AppId,\r\n        method: 'GET',\r\n        cache: false,\r\n        contentType: 'application/json'\r\n      }).success(function (data) {\r\n        var ticket = data;\r\n        window.localStorage.setItem($scope.AppId + \"_ticket\", ticket);\r\n        var String1 = \"jsapi_ticket=\" + ticket + \"&noncestr=n580440&timestamp=1437377735&url=\" + window.location.href;\r\n        window.localStorage.setItem($scope.AppId + \"_signature\", hex_sha1(String1)); //alert(String1);\r\n        $scope.Load_WX();\r\n      });\r\n    });\r\n  };\r\n  $scope.Load_WX();\r\n\r\n  //录音\r\n  $scope.startRecord = function () {\r\n    //切換錄音class圖案\r\n    $scope.isRecord = 'stopRecord';\r\n    wx.startRecord({\r\n      success: function (res) {\r\n        $scope.isStart = true;\r\n        $scope.$apply();\r\n      }\r\n    });\r\n    wx.onVoiceRecordEnd({\r\n      // 录音时间超过一分钟没有停止的时候会执行 complete 回调\r\n      complete: function (res) {\r\n        //切換錄音class圖案\r\n        $scope.isRecord = 'playVoice';\r\n        $scope.isStart = false;\r\n        $scope.setData.localId = res.localId;\r\n        $scope.$apply();\r\n      }\r\n    });\r\n  };\r\n  $scope.stopRecord = function () {\r\n    //切換錄音class圖案\r\n    $scope.isRecord = 'playVoice';\r\n    wx.stopRecord({\r\n      success: function (res) {\r\n        $scope.isStart = false;\r\n        $scope.setData.localId = res.localId;\r\n        $scope.$apply();\r\n      }\r\n    });\r\n  };\r\n  //播放錄音\r\n  $scope.playVoice = function () {\r\n    $scope.isRecord = 'pauseVoice';\r\n    wx.playVoice({\r\n      localId: $scope.setData.localId // 需要播放的音频的本地ID，由stopRecord接口获得\r\n    });\r\n  };\r\n  //暫停播放\r\n  $scope.pauseVoice = function () {\r\n    $scope.isRecord = 'playVoice';\r\n    wx.pauseVoice({\r\n      localId: $scope.setData.localId // 需要暂停的音频的本地ID，由stopRecord接口获得\r\n    });\r\n  };\r\n\r\n  //定位 使用微信取得座標 再用百度地圖逆轉換成地名\r\n  $scope.BDpos = '';\r\n  $scope.latitude = '';\r\n  $scope.longitude = '';\r\n  $scope.getLocation = function () {\r\n    //開啟地圖loading圖示\r\n    $scope.isgetLocationLoading = true;\r\n    //微信取得座標函式\r\n    wx.getLocation({\r\n      type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'\r\n      success: function (res) {\r\n\r\n        //這是GPS座標 使用百度需轉換成他們的座標\r\n        $scope.latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90\r\n        $scope.longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。\r\n        setTimeout(function () {\r\n          var ggPoint = new BMap.Point($scope.longitude, $scope.latitude);\r\n          var convertor = new BMap.Convertor();\r\n          var pointArr = [];\r\n          pointArr.push(ggPoint);\r\n          convertor.translate(pointArr, 1, 5, $scope.translateCallback)\r\n        }, 1500)\r\n      }\r\n    });\r\n    //轉換座標\r\n    $scope.translateCallback = function (data) {\r\n      if (data.status === 0) {\r\n        $scope.BDpos = new BMap.Point(data.points[0].lng, data.points[0].lat);\r\n      } else {\r\n        //關閉地圖loading圖示\r\n        $scope.isgetLocationLoading = false;\r\n        alert(i18n.t(\"20052\"))\r\n        $scope.$apply();\r\n      }\r\n\r\n      //逆轉換成地名     \r\n      // 创建地理编码实例\r\n      var myGeo = new BMap.Geocoder();\r\n      // 根据坐标得到地址描述    \r\n      myGeo.getLocation($scope.BDpos, function (result) {\r\n        if (result) {\r\n          $scope.setData.address = result.address;\r\n          //關閉地圖loading圖示\r\n          $scope.isgetLocationLoading = false;\r\n          alert(i18n.t(\"20053\"))\r\n          $scope.$apply();\r\n        } else {\r\n          //關閉地圖loading圖示\r\n          $scope.isgetLocationLoading = false;\r\n          alert(i18n.t(\"20052\"))\r\n          $scope.$apply();\r\n        }\r\n      });\r\n    }\r\n  };\r\n\r\n  //定義儲存物件\r\n  $scope.setData = {\r\n    species: '', //種類ID\r\n    type: '', //品牌\r\n    time: '', //時間\r\n    localId: '', //錄音暫存\r\n    serverId: '', //錄音上傳取得\r\n    reason: '', //原因\r\n    reasonSelect: '', //選擇原因ID\r\n    address: '', //地址\r\n    userName: '', //姓名\r\n    userTel: '', //電話\r\n  };\r\n  //保存驗證碼資訊post用\r\n  $scope.keyData = {\r\n    Code: '',\r\n    ExpireTime: '',\r\n    Passcode: ''\r\n  }\r\n\r\n  //保存新增報修單需要資訊post用\r\n  $scope.setRepairData = {\r\n    ICauseIds: [], //原因(選擇)\r\n    ICallInOrOut: 11,\r\n    RequisitionNote: {},\r\n    Source: 4,\r\n    UserId: \"\", //電話\r\n    UnitId: \"TSHLJ_C\",\r\n    Unit: \"\",\r\n    Level2Name: \"\",\r\n    Level3Name: \"\",\r\n    EquipmentId: \"\", //種類\r\n    IPositionIds: [],\r\n    Description: \"\", //原因(手打)\r\n    CauseIds: \"\",\r\n    StrongholdInfo: \"\",\r\n    OpenID: $scope.OpenId,\r\n    Brand: \"\", //品牌\r\n    EstArrivalTime: \"\", //時間\r\n    UserName: \"\", //姓名\r\n    Address: \"\" //地址\r\n  }\r\n  //保存serverID上傳保存用\r\n  $scope.MediasParamenter = {\r\n    Key: '',\r\n    FileSoure: 40,\r\n    Medias: {\r\n      image: [],\r\n      voice: []\r\n    }\r\n  };\r\n  //設定換頁參數 使用這個控制換頁\r\n  $scope.isShow = 1;\r\n  //設定輸入問題介面跳出視窗\r\n  $scope.isHideText = true;\r\n  //初始日期 傳入setDate.time用\r\n  $scope.setDateInit = '';\r\n  //初始時間 傳入setDate.time用\r\n  $scope.setTimeInit = '';\r\n  //判斷是否是今天\r\n  $scope.isToday = null;\r\n  //暫存時間套件設定用\r\n  $scope.timeOption = '';\r\n  //錄音開始與否\r\n  $scope.isStart = false;\r\n  //錄音區塊切換開關\r\n  $scope.isRecord = 'startRecord';\r\n  //選擇的設備名稱\r\n  $scope.selectorEquipmentName = '';\r\n  //選擇的品牌名稱\r\n  $scope.selectorBrand = '';\r\n  //種類索引 找出相對品牌用\r\n  $scope.selectorIndex = '';\r\n  //報修原因ID\r\n  $scope.selectorEquipmentSubTypeId = '';\r\n  //報修單代號\r\n  $scope.CaseNo = '';\r\n  //possport\r\n  $scope.passport = '';\r\n  //儲存加入種類method\r\n  $scope.addSpecies = function (speciesList, index) {\r\n    //儲存加入種類\r\n    $scope.setData.species = speciesList.EquipmentId;\r\n    //加入選擇的設備名稱\r\n    $scope.selectorEquipmentName = speciesList.EquipmentName;\r\n    //加入報修原因ID\r\n    $scope.selectorEquipmentSubTypeId = speciesList.EquipmentSubTypeId;\r\n    //加入品牌ID\r\n    $scope.selectorIndex = index;\r\n    //記得換頁\r\n    $scope.isShow += 1;\r\n  }\r\n\r\n  //儲存加入品牌method\r\n  $scope.addType = function (typeList) {\r\n    //儲存加入品牌\r\n    $scope.setData.type = typeList;\r\n    $scope.selectorBrand = typeList;\r\n    //記得換頁\r\n    $scope.isShow += 1;\r\n  }\r\n  //維修時間判斷開關\r\n  $scope.timeSwitch = function () {\r\n    var sw = $scope.setTimeInit == '' || $scope.setDateInit == '';\r\n    return sw;\r\n  }\r\n  //時間套件開關 套件用jQuery\r\n  setTimeout(function () {\r\n    var yesterday = new Date((new Date()).valueOf() - 1000 * 60 * 60 * 24);\r\n    $('.datepicker').pickadate({\r\n      disable: [{\r\n        from: [0, 0, 0],\r\n        to: yesterday\r\n      }],\r\n      onSet: function (context) {\r\n        $scope.isToday = Math.floor(new Date(context.select) - Math.floor(new Date()));\r\n        var inputpick = $('.timepicker').pickatime();\r\n        var pick = inputpick.pickatime('picker');\r\n        pick.set('disable', false);\r\n        if ($scope.isToday <= 0) {\r\n          pick.set('disable', [{\r\n            from: [0, 0, 0],\r\n            to: yesterday\r\n          }]);\r\n        } else {\r\n          pick.set('disable', []);\r\n        }\r\n        $scope.$apply();\r\n      }\r\n    });\r\n  }, 0);\r\n\r\n  //加入維修時間\r\n  $scope.addTime = function () {\r\n    $scope.setData.time = $scope.setDateInit + $scope.setTimeInit;\r\n\r\n    //記得換頁\r\n    $scope.isShow += 1;\r\n  }\r\n\r\n  //加入維修原因\r\n  $scope.addReason = function (text) {\r\n    $scope.setData.reason = text;\r\n\r\n    // 填寫問題欄位隱藏\r\n    $scope.isHideText = !$scope.isHideText;\r\n  }\r\n\r\n  //重設錄音\r\n  $scope.resetRecord = function () {\r\n    $scope.isRecord = 'startRecord';\r\n    $scope.setData.localId = '';\r\n  }\r\n\r\n  //原因disable\r\n  $scope.causeDisable = function () {\r\n    var reason = $scope.setData.reason == '' || $scope.setData.reason == undefined;\r\n    var reasonSelect = $scope.setData.reasonSelect == '';\r\n    var localId = $scope.setData.localId == '';\r\n    return reason && reasonSelect && localId;\r\n  }\r\n\r\n  //驗證碼\r\n  $scope.sendTelNum = function () {\r\n    $http({\r\n        url: ApiMapper.sApi + '/s/retail/passcode',\r\n        method: 'POST',\r\n        contentType: 'application/json',\r\n        data: {\r\n          PhoneNo: $scope.setData.userTel\r\n        }\r\n      })\r\n      .success(function (data) {\r\n        $scope.keyData.Code = data.Code;\r\n        $scope.keyData.ExpireTime = data.ExpireTime;\r\n        setTimeout(function () {\r\n          alert(i18n.t(\"20054\"));\r\n          console.log($scope.keyData);\r\n        }, 500)\r\n      })\r\n      .error(function (error) {\r\n        setTimeout(function () {\r\n          if ($scope.setData.userTel == '' || $scope.setData.userTel == undefined) {\r\n            alert(i18n.t(\"20055\"));\r\n          } else {\r\n            alert(i18n.t(\"20056\"))\r\n          }\r\n        }, 500)\r\n      });\r\n  }\r\n\r\n  //判斷user的內容是否正確\r\n  $scope.uesrFilter = function () {\r\n    var reg = /^\\d+$/;\r\n    var address = $scope.setData.address == '';\r\n    var userName = $scope.setData.userName == '';\r\n    var key = $scope.keyData.Passcode == '';\r\n    var tel = !reg.test($scope.setData.userTel);\r\n    return address || userName || key || tel;\r\n  }\r\n\r\n  //加入使用者資訊\r\n  $scope.addUserInfo = function (address, userName, userTel) {\r\n    $scope.setData.address = address;\r\n    $scope.setData.userName = userName;\r\n    $scope.setData.userTel = userTel;\r\n    //把使用者資訊保存到給需存入資料庫的資料裡\r\n    $scope.setRepairData.ICauseIds.push($scope.setData.reasonSelect);\r\n    $scope.setRepairData.CauseIds = $scope.setData.reasonSelect;\r\n    $scope.setRepairData.UserId = $scope.setData.userTel;\r\n    $scope.setRepairData.EquipmentId = $scope.setData.species;\r\n    $scope.setRepairData.Description = $scope.setData.reason;\r\n    $scope.setRepairData.Brand = $scope.setData.type;\r\n    $scope.setRepairData.EstArrivalTime = $scope.setData.time;\r\n    $scope.setRepairData.UserName = $scope.setData.userName;\r\n    $scope.setRepairData.Address = $scope.setData.address;\r\n    console.log($scope.setData);\r\n    console.log($scope.setRepairData);\r\n    //判斷驗證碼是否正確 錯誤跳出此function\r\n    $http({\r\n        url: ApiMapper.sApi + '/s/retail/passcode/confirm',\r\n        method: 'POST',\r\n        contentType: 'application/json',\r\n        data: $scope.keyData\r\n      })\r\n      .success(function (data) {\r\n        //呼叫執行promise\r\n        $scope.stratPromise();\r\n      })\r\n      .error(function (error) {\r\n        alert(error.Messages);\r\n      });\r\n  }\r\n\r\n  //上傳錄音的promise 取得serverID\r\n  $scope.uploadVoicePromise = function () {\r\n    var mydefer = $q.defer();\r\n    var myPromise = mydefer.promise;\r\n    if ($scope.setData.localId == '') {\r\n      //如果沒錄音直接跳下一個promise\r\n      mydefer.resolve('success');\r\n    }\r\n    wx.uploadVoice({\r\n      localId: $scope.setData.localId, // 需要上传的音频的本地ID，由stopRecord接口获得\r\n      isShowProgressTips: 1, // 默认为1，显示进度提示\r\n      success: function (res) {\r\n        $scope.setData.serverId = res.serverId; // 返回音频的服务器端ID\r\n        mydefer.resolve('success');\r\n      }\r\n    });\r\n    return myPromise;\r\n  }\r\n\r\n  //上傳錄音到580440 綁定維修單申請ID\r\n  $scope.LoadMedias = function (RequisitionId) {\r\n    $scope.MediasParamenter.Key = RequisitionId;\r\n    $scope.MediasParamenter.Medias.voice.push($scope.setData.serverId);\r\n    $http({\r\n      url: ApiMapper.wxApi + '/wx/files/' + $scope.AppId,\r\n      method: 'POST',\r\n      contentType: 'application/json',\r\n      headers: {\r\n        'Passport': $scope.passport\r\n      },\r\n      data: $scope.MediasParamenter\r\n    }).success(function (data) {\r\n      if (data != \"Saved\") {\r\n        alert(i18n.t(\"20057\")+'\\n\\r'+i18n.t(\"20007\"));\r\n      } else {\r\n        alert(i18n.t(\"20058\")+'\\n\\r'+i18n.t(\"20059\")+'：' + $scope.CaseNo);\r\n        //微信關閉網頁用\r\n        wx.closeWindow();\r\n      }\r\n    }).error(function () {\r\n      alert(i18n.t(\"20057\")+'\\n\\r'+i18n.t(\"20007\"));\r\n    });\r\n  }\r\n\r\n  //串接綁定openID與580帳號並獲取passport(散戶) API\r\n  $scope.getPassportApi = function () {\r\n    var mydefer = $q.defer();\r\n    var myPromise = mydefer.promise;\r\n    $http({\r\n        url: ApiMapper.wxApi + '/wx/reg/retail/' + $scope.OpenId + '/' + $scope.AppId,\r\n        method: 'PATCH',\r\n        contentType: 'application/json',\r\n        data: {\r\n          PhoneNo: $scope.setData.userTel,\r\n          UserName: $scope.setData.userName,\r\n        }\r\n      })\r\n      .success(function (data) {\r\n        console.log(data);\r\n        $scope.passport = data.o[0].Passport;\r\n        $scope.setRepairData.Unit = data.o[0].Unit;\r\n        console.log('要post給後端的資料');\r\n        console.log(JSON.stringify($scope.setRepairData));\r\n        mydefer.resolve('success');\r\n      })\r\n      .error(function (error) {\r\n        alert(error.Messages);\r\n      });\r\n    return myPromise;\r\n  }\r\n  //新增報修單API\r\n  $scope.addRepairApi = function () {\r\n    $http({\r\n        url: ApiMapper.sApi + '/s/rez',\r\n        method: 'POST',\r\n        contentType: 'application/json',\r\n        headers: {\r\n          'Passport': $scope.passport\r\n        },\r\n        data: JSON.stringify($scope.setRepairData)\r\n      })\r\n      .success(function (data) {\r\n        console.log(data);\r\n        if ($scope.setData.serverId != '') {\r\n          $scope.CaseNo = data.CaseNo;\r\n          $scope.LoadMedias(data.RequisitionId);\r\n        } else {\r\n          alert(i18n.t(\"20058\")+'\\n\\r'+i18n.t(\"20059\")+'：' + data.CaseNo);\r\n          //微信關閉網頁用\r\n          wx.closeWindow();\r\n        }\r\n      })\r\n      .error(function (error) {\r\n        console.log('加入報修單錯誤');\r\n        alert(error.Message);\r\n      });\r\n  }\r\n  //使用promise function\r\n  $scope.stratPromise = function () {\r\n    //上傳錄音\r\n    var uploadVoice = $scope.uploadVoicePromise();\r\n    uploadVoice\r\n      .then(function (data) {\r\n        if (data == 'success') {\r\n          console.log('serverID: ' + $scope.setData.serverId);\r\n          var getPassportApi = $scope.getPassportApi();\r\n          return getPassportApi;\r\n        }\r\n      })\r\n      //綁定散戶資訊\r\n      .then(function (data) {\r\n        if (data == 'success') {\r\n          //加入報修單\r\n          $scope.addRepairApi();\r\n        }\r\n      })\r\n  }\r\n}]);"]}
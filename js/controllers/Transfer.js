"use strict";WeChat.controller("TransferCtrl",["$scope","$http","$cookies","$timeout","$mdSidenav","$mdUtil","$cacheFactory","i18n",function(i,t,n,e,a,o,s,r){i.UserId=n.UserId,i.UnitId=n.UnitId,i.Unit=n.Unit,i.StoreUser=n.StoreUser,i.Passport=n.Passport,i.AppId=window.localStorage.getItem("b2c_appId"),i.ChangeTag=0,i.QRCodeStr="",i.supportInfo={},i.supportShow=!1,i.SupportList=[],i.UnitInfo={Unit:"",UnitId:"",PassCode:""},i.ViewObj={QRCodeStr:"",ChangeTag:0},0==parseInt(i.StoreUser)&&(i.ViewObj.ChangeTag=2),i.FormatDATE=function(e){var t=new Date(e),n=t.getFullYear(),i=t.getMonth()+1,a=t.getDate();t.getHours(),t.getMinutes(),t.getSeconds();return n+"/"+i+"/"+a},i.GetNow=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,i=e.getDate();e.getHours(),e.getMinutes(),e.getSeconds();return t+"/"+n+"/"+i},i.ValidtorTime=function(e,t){var n=new Date(e).getTime();return!(new Date(t).getTime()<=n)},i.Load_WX=function(){wx.config({debug:!1,appId:i.AppId,timestamp:1437377735,nonceStr:"n580440",signature:window.localStorage.getItem(i.AppId+"_signature"),jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","translateVoice","startRecord","stopRecord","onRecordEnd","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard"]}),wx.error(function(e){t({url:ApiMapper.wxApi+"/wx/r/ticket/"+i.AppId,method:"GET",cache:!1,contentType:"application/json"}).success(function(e){var t=e;window.localStorage.setItem(i.AppId+"_ticket",t);var n="jsapi_ticket="+t+"&noncestr=n580440&timestamp=1437377735&url="+window.location.href;window.localStorage.setItem(i.AppId+"_signature",hex_sha1(n)),i.Load_WX()})})},i.Load_WX(),wx.ready(function(){0==parseInt(i.StoreUser)&&(i.ChangeTag=2)}),i.loadQRcode=function(){t({url:ApiMapper.sApi+"/s/unit/info/qrcode/"+i.UnitId,contentType:"application/json",headers:{Passport:n.Passport},method:"GET"}).success(function(e){i.ViewObj.QRCodeUri=e}).error(function(e){alert(e.Messages)})},i.loadQRcode(),i.ToscanQRCode=function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){i.QRCodeStr=e.resultStr,t({url:ApiMapper.sApi+"/s/unit/info/decrypt?encrypt="+encodeURIComponent(i.QRCodeStr),contentType:"application/json",headers:{Passport:n.Passport},method:"GET"}).success(function(e){i.UnitInfo.Unit=e.UnitName,i.UnitInfo.UnitId=e.UnitId,i.UnitInfo.PassCode=e.PassCode}).error(function(e){alert(e.Messages)})}})},i.getSupportInfo=function(){t({url:ApiMapper.sApi+"/s/user/records/"+i.UserId,method:"GET",contentType:"application/json",headers:{Passport:i.Passport}}).success(function(e){0<e.length&&_.each(e,function(e){i.ValidtorTime(i.GetNow(),e.StartTime)||i.ValidtorTime(e.EndTime,i.GetNow())||(e.StartTime=i.FormatDATE(e.StartTime),e.EndTime=i.FormatDATE(e.EndTime),i.supportInfo=e,i.supportShow=!0,i.SupportList.push(e))})}).error(function(e){alert(e.Messages)})},i.getSupportInfo(),i.TransferSubmit=function(){if(i.isSubmit=!0,i.ApiStr=ApiMapper.sApi+"/s/user/transfer/"+i.UserId,i.PostParames={Source:4,UnitId:i.UnitInfo.UnitId,PassCode:i.UnitInfo.PassCode},i.alertStr="是否调店至",i.UnitInfo.UnitId.toUpperCase()==i.UnitId.toUpperCase())return 0==parseInt(i.ChangeTag)?(i.isSubmit=!1,alert("调职门店和当前门店一样，不需要调店！")):(i.isSubmit=!1,alert("支援门店和当前门店一样，不允许操作！")),!1;if(1==parseInt(i.ChangeTag)){if(i.ApiStr=ApiMapper.sApi+"/s/user/support/"+i.UserId,i.alertStr="是否支援门店：",i.StartTime=$("#StartTime").val(),i.EndTime=$("#EndTime").val(),""==i.StartTime||""==i.EndTime)return i.isSubmit=!1,alert("请选择支援起迄日期！"),!1;if(i.ValidtorTime(i.FormatDATE(i.EndTime),i.FormatDATE(i.StartTime)))return i.isSubmit=!1,alert("开始时间必须早于结束时间！"),!1;if(i.ValidtorTime(i.FormatDATE(i.EndTime),i.GetNow()))return i.isSubmit=!1,alert("结束时间需晚于当前时间！"),!1;i.PostParames={Info:{Source:4,UnitId:i.UnitInfo.UnitId,Unit:i.UnitInfo.Unit,StartTime:i.StartTime,EndTime:i.EndTime},PassCode:i.UnitInfo.PassCode}}""==i.UnitInfo.Unit?t({url:ApiMapper.sApi+"/s/unit/"+i.UnitInfo.UnitId,contentType:"application/json",headers:{Passport:n.Passport},method:"GET"}).success(function(e){"null"!=e.StatusCode&&null!=e.StatusCode?(i.isSubmit=!1,alert("门店编号不对，请重新输入！")):(i.UnitInfo.Unit=e.Unit,confirm(i.alertStr+"<"+i.UnitInfo.Unit+">")?t({url:i.ApiStr,method:"PATCH",contentType:"application/json",headers:{Passport:i.Passport},data:i.PostParames}).success(function(e){1==e.StatusCode&&1==parseInt(i.ChangeTag)?(alert("支援门店<"+i.UnitInfo.Unit+">成功！"),wx.closeWindow()):1==e.StatusCode&&0==parseInt(i.ChangeTag)?(alert("成功调店至<"+i.UnitInfo.Unit+">！"),wx.closeWindow()):(i.isSubmit=!1,alert(e.Messages))}).error(function(e){i.isSubmit=!1,alert(e.Messages)}):(i.UnitInfo.Unit="",i.isSubmit=!1))}).error(function(e){i.isSubmit=!1,alert("网络错误请联系报修中心！")}):confirm(i.alertStr+"<"+i.UnitInfo.Unit+">")?t({url:i.ApiStr,method:"PATCH",contentType:"application/json",headers:{Passport:i.Passport},data:i.PostParames}).success(function(e){1==e.StatusCode&&1==parseInt(i.ChangeTag)?(alert("支援门店<"+i.UnitInfo.Unit+">成功！"),wx.closeWindow()):1==e.StatusCode&&0==parseInt(i.ChangeTag)?(alert("成功调店至<"+i.UnitInfo.Unit+">！"),wx.closeWindow()):(i.isSubmit=!1,alert(e.Messages))}).error(function(e){i.isSubmit=!1,alert(e.Messages)}):(i.UnitInfo.Unit="",i.isSubmit=!1)}}]).controller("AddAllotCtrl",["$scope","$http","$cookies","$timeout","$mdSidenav","$modal","$mdDialog","i18n",function(i,n,a,e,t,o,s,r){i.StoreUser=a.StoreUser,i.CompanyId=a.CompanyId,i.StoreUser=a.StoreUser,i.Unit=a.Unit,i.Maintenance=0,i.AppId=ApiMapper.AppId,i.OpenId=window.localStorage.getItem(i.AppId),i.EquipmentName="",i.OpenModalTag="Source",i.MoveOrderParameters={RequisitionId:null,MoveType:1,IsMove:!1,IsClose:!1,SourceId:a.UnitId,Source:a.Unit,TargetId:"",Target:"",Remark:"",EquipmentId:"",EquipmentName:""},i.EquipmentList=[{EquipmentTypeClass:0,ClassName:"设备",children:[]},{EquipmentTypeClass:1,ClassName:"设施",children:[]},{EquipmentTypeClass:2,ClassName:"资讯",children:[]},{EquipmentTypeClass:99,ClassName:"其它",children:[]}],i.StoreList=[],i.EquipmentList=[],i.isSubmit=!1,i.IsShowToScanQRCode=!1,i.IsShowAddCause=!1,i.IsWPStylePriorityList=!1,i.IsAutoSetPosition=!1;var c=["f96f98e2-38f9-456a-9813-82d899536a82","eb296708-6fc6-43f0-b506-0ca0fa91e1cd","6c690014-2571-48db-ac5a-c6ba2572a3bb","c1a24352-46a1-4301-9b96-a67c92691336","C4B0E179-8121-487E-AA63-59635ACF2447"];-1<c.indexOf(a.CompanyId)&&(i.IsShowToScanQRCode=!0,i.IsShowAddCause=!0,i.IsWPStylePriorityList=!0,"f96f98e2-38f9-456a-9813-82d899536a82"!==a.CompanyId&&"c1a24352-46a1-4301-9b96-a67c92691336"!==a.CompanyId&&(i.isWPStoreUser=!0)),-1<c.indexOf(a.CompanyId)&&(i.IsAutoSetPosition=!0),i.GetStore=function(){n({url:ApiMapper.sApi+"/s/unit/maps",method:"GET",cache:!0,contentType:"application/json",headers:{Passport:a.Passport}}).success(function(e){i.Unitdata=e,_.each(e[1],function(t){i.UnitLeve4data=[],t.isSelected=!1,_.each(e[3],function(e){i.UnitLeve4data.push(e),e.Level2==t.UnitId&&(e.Level2Name=t.Unit,e.isSelected=!1),e.UnitId==a.UnitId&&(i.MoveOrderParameters.SourceId=e.UnitId,i.MoveOrderParameters.Source=e.Unit,i.GetEquipment(a.UnitId))}),i.StoreList.push(t)})}).error(function(e){alert("获取部门信息错误！")})},i.GetStore(),i.GetEquipment=function(e){var t={UnitId:i.MoveOrderParameters.SourceId,TopicType:1,Maintenance:i.Maintenance};"eb296708-6fc6-43f0-b506-0ca0fa91e1cd"!=i.CompanyId&&"6c690014-2571-48db-ac5a-c6ba2572a3bb"!=i.CompanyId&&"c1a24352-46a1-4301-9b96-a67c92691336"!=i.CompanyId||(t.TopicType=3,i.EquipmentList[0]={EquipmentTypeClass:0,ClassName:"设备",children:[]},i.EquipmentList[1]={EquipmentTypeClass:1,ClassName:"设施",children:[]},i.GetFacilities()),n({url:ApiMapper.sApi+"/s/equipment/classification",method:"POST",contentType:"application/json",headers:{Passport:a.Passport},data:JSON.stringify(t)}).success(function(e){i.EquipmentList=[{EquipmentTypeClass:0,ClassName:"设备",children:[]},{EquipmentTypeClass:1,ClassName:"设施",children:[]},{EquipmentTypeClass:2,ClassName:"资讯",children:[]},{EquipmentTypeClass:99,ClassName:"其它",children:[]}],"eb296708-6fc6-43f0-b506-0ca0fa91e1cd"==i.CompanyId||"6c690014-2571-48db-ac5a-c6ba2572a3bb"==i.CompanyId||"c1a24352-46a1-4301-9b96-a67c92691336"==i.CompanyId?i.EquipmentList[0].children=e:(_.each(e,function(t){var e=t.children;_.each(e,function(n){n.EquipmentTypeName=t.EquipmentTypeName;var e=n.EquipmentCode.split("-");n.SortNo=parseInt(e[1]),i.EquipmentList.forEach(function(e,t){e.EquipmentTypeClass==n.EquipmentTypeClass&&i.EquipmentList[t].children.push(n)})})}),_.each(i.EquipmentList,function(e){e.children=_.sortBy(e.children,"SortNo")}))})},i.GetFacilities=function(){var e={UnitId:i.MoveOrderParameters.SourceId,TopicType:4,Maintenance:i.Maintenance};n({url:ApiMapper.sApi+"/s/equipment/classification",method:"POST",contentType:"application/json",headers:{Passport:a.Passport},data:JSON.stringify(e)}).success(function(e){_.each(e,function(n){var e=n.children;_.each(e,function(e){e.EquipmentTypeName=n.EquipmentTypeName;var t=e.EquipmentCode.split("-");e.SortNo=parseInt(t[1]),i.EquipmentList[1].children.push(e)})})})},i.ShowArea=function(e,t){"设施"===t&&i.isWPStoreUser?i.isShowArea=!1:i.isShowArea=!0,i.MoveOrderParameters.EquipmentId=e.EquipmentId,i.MoveOrderParameters.EquipmentName=e.EquipmentName,i.closeDenav("EQ")},i.isSelectLeve2=function(t){_.each(i.Unitdata[1],function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&(i.AreaIds=[t.UnitId],i.ProvinceIds=[]),i.UnitLeve3data=_.filter(i.Unitdata[2],function(e){return e.Level2==t.UnitId})},i.isSelectLeve2=function(t){_.each(i.Unitdata[1],function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&(i.AreaIds=[t.UnitId],i.ProvinceIds=[]),i.UnitLeve3data=_.filter(i.Unitdata[2],function(e){return e.Level2==t.UnitId})},i.isSelectLeve3=function(t){_.each(i.Unitdata[2],function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&(i.ProvinceIds=[t.UnitId])},i.reLoadLeve4=function(){i.UnitLeve4data=_.filter(i.Unitdata[3],function(e){return 0<i.ProvinceIds.length?e.Level3==i.ProvinceIds[0]:e.Level2==i.AreaIds[0]})},i.isSelectLeve4=function(t){console.log(t),_.each(i.UnitLeve4data,function(e){e.isSelected=!1,e.UnitId==t.UnitId&&(t.isSelected=!t.isSelected)}),t.isSelected&&("Target"==i.OpenModalTag?(i.MoveOrderParameters.TargetId=t.UnitId,i.MoveOrderParameters.Target=t.Unit):(i.MoveOrderParameters.SourceId=t.UnitId,i.MoveOrderParameters.Source=t.Unit,i.GetEquipment(i.MoveOrderParameters.SourceId)),console.log(i.MoveOrderParameters))},i.toggleRight=function(e){"Target"===(i.OpenModalTag=e)||"Source"===e?t("Store").open():t("EQ").open()},i.closeDenav=function(e){"Store"===e?(_.each(i.UnitLeve4data,function(e){e.isSelected=!1}),t("Store").close()):t("EQ").close()},i.EQ_close=function(e){t("EQ").close().then(function(){})},i.MoveOrderSubmit=function(){""==i.MoveOrderParameters.EquipmentId?alert("请选择调拨品项"):n({url:ApiMapper.sApi+"/s/moveOder/create",method:"POST",contentType:"application/json",headers:{Passport:a.Passport},data:i.MoveOrderParameters}).success(function(e){i.isSubmit=!1,alert("调拨成功！详情请只调拨列表查看。"),i.MoveOrderParameters={RequisitionId:null,MoveType:1,SourceId:a.UnitId,Source:a.Unit,TargetId:"",Target:"",Remark:"",IsMove:!1,IsClose:!1,EquipmentId:"",EquipmentName:""}}).error(function(e){i.isSubmit=!1,alert(e.Messages)})}}]);
//# sourceMappingURL=Transfer.js.map
